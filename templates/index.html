<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGallery: {{ current_folder_info.display_name }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='galleryout/favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <!-- Alpine.js Core + Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        :root {
            /* Inkwell UI: Core Palette - Strict Monochrome + Single Accent */
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --surface-hover: #2a2a2a;
            --border-color: #333333;
            --text-color: #EAEAEA;
            --text-muted: #888888;
            --accent-yellow: #FFD60A;
            --danger-color: #FF4d4d;
            --success-color: #52c41a;

            /* Typography Scale - Standardized */
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-monospace: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            
            /* Font Sizes - 8px base scale */
            --text-xs: 0.75rem;   /* 12px - labels, badges */
            --text-sm: 0.875rem;  /* 14px - secondary info */
            --text-base: 1rem;    /* 16px - body text */
            --text-lg: 1.125rem;  /* 18px - large body */
            --text-xl: 1.25rem;   /* 20px - small headers */
            --text-2xl: 1.5rem;   /* 24px - medium headers */
            --text-3xl: 1.875rem; /* 30px - large headers */
            
            /* Spacing Scale - 8px base unit */
            --space-1: 0.5rem;   /* 8px */
            --space-2: 0.75rem;  /* 12px */
            --space-3: 1rem;     /* 16px */
            --space-4: 1.5rem;   /* 24px */
            --space-5: 2rem;     /* 32px */
            --space-6: 3rem;     /* 48px */

            /* Shadows - Subtle depth only */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.15);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.35);
            
            /* Layout */
            --sidebar-width: 320px;
            
            /* Transitions - Standardized */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        /* Accessibility: Consistent Focus States */
        *:focus-visible {
            outline: 2px solid var(--accent-yellow);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Remove default focus outline for mouse users */
        *:focus:not(:focus-visible) {
            outline: none;
        }
        
        html { 
            scroll-behavior: smooth; 
            font-size: 16px; /* Base size for rem calculations */
        }
        
        body { 
            font-family: var(--font-body);
            font-size: var(--text-base);
            font-weight: 400;
            margin: 0; 
            background: var(--bg-color); 
            color: var(--text-color); 
            line-height: 1.6; 
            display: flex; 
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body.lightbox-open, body.modal-open { overflow: hidden; }
        
        /* ===================================
           NOTIFICATION SYSTEM
           =================================== */
        #notification-container { 
            position: fixed; 
            top: var(--space-4); 
            right: var(--space-4); 
            z-index: 10000; 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-2); 
            align-items: flex-end; 
        }
        
        .notification { 
            background-color: var(--surface-color); 
            color: var(--text-color); 
            padding: var(--space-2) var(--space-4); 
            border-radius: 4px; 
            box-shadow: var(--shadow-lg); 
            border-left: 3px solid var(--accent-yellow); 
            opacity: 0; 
            transform: translateX(100%); 
            transition: all var(--transition-base); 
            font-weight: 600; 
            font-size: var(--text-sm);
            max-width: 400px;
        }
        
        .notification.show { 
            opacity: 1; 
            transform: translateX(0); 
        }
        
        .notification.success { 
            background-color: var(--success-color); 
            color: white; 
            border-color: #1a9c77; 
        }
        
        .notification.error { 
            background-color: var(--danger-color); 
            color: white; 
            border-color: #b32a38; 
        }
        
        .notification.warning { 
            background-color: var(--accent-yellow); 
            color: var(--bg-color); 
            border-color: #d39e00; 
            font-weight: 700; 
        }
        
        .notification.info { 
            background-color: var(--surface-hover); 
            color: var(--text-color); 
            border-color: var(--border-color); 
        }

        /* ===================================
           SIDEBAR NAVIGATION
           =================================== */
        .sidebar { 
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width); 
            background: var(--surface-color); 
            border-right: 1px solid var(--border-color); 
            padding: var(--space-4); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            position: sticky; 
            top: 0; 
            transition: min-width var(--transition-slow), transform var(--transition-slow); 
            z-index: 1000; 
        }
        
        body.sidebar-expanded .sidebar { 
            min-width: 600px; 
        }
        
        .main-content { 
            flex-grow: 1; 
            padding-bottom: 80px; 
            transition: margin-left var(--transition-base);
        }
        
        .sidebar-header { 
            margin-bottom: var(--space-4); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: var(--space-3); 
            flex-shrink: 0;
        }
        
        .sidebar-header h1 { 
            margin: 0; 
            font-size: var(--text-3xl); 
            font-weight: 700; 
            color: var(--text-color); 
            letter-spacing: -0.02em;
        }
        #sidebar-toggle-btn { display: none; background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; align-items: center; gap: 0.5rem; }
        /* ===================================
           FOLDER CONTROLS & BUTTONS
           =================================== */
        .folder-controls { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-2); 
            margin-bottom: var(--space-3); 
            flex-shrink: 0;
        }
        
        .folder-search-input { 
            width: 100%; 
            background: var(--bg-color); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            padding: var(--space-2) var(--space-3); 
            font-size: var(--text-sm); 
            font-family: var(--font-body);
            transition: all var(--transition-fast);
        }
        
        .folder-search-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }
        
        .folder-search-input:hover {
            border-color: var(--text-muted);
        }
        
        .folder-search-input:focus {
            border-color: var(--accent-yellow);
            background: var(--bg-color);
        }
        
        .folder-sort-buttons { 
            display: flex; 
            gap: var(--space-1); 
        }
        
        .folder-sort-buttons button { 
            flex-grow: 1; 
            background: var(--surface-hover); 
            color: var(--text-muted); 
            border: 1px solid var(--border-color); 
            padding: var(--space-2); 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: var(--text-sm);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 0.25rem; 
            font-family: var(--font-monospace); 
            transition: all var(--transition-fast);
        }
        
        .folder-sort-buttons button:hover {
            background: var(--surface-color);
            border-color: var(--text-muted);
        }
        
        .folder-sort-buttons button.active { 
            background: var(--surface-color); 
            color: var(--accent-yellow); 
            border-color: var(--accent-yellow); 
        }
        
        .folder-sort-buttons button svg { 
            width: 16px; 
            height: 16px; 
        }
        .sidebar-actions { display: flex; gap: 0.5rem; align-items: center; }
        .sidebar-actions button { background: none; border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; padding: 0.5rem 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 150ms ease-out; }
        .sidebar-actions button:hover { background: var(--surface-hover); border-color: var(--text-muted); }
        .folder-tree-container { flex-grow: 1; overflow-y: auto; min-height: 0; }
        .folder-tree, .folder-tree ul { list-style: none; padding: 0; margin: 0; }
        .folder-item { display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; transition: background-color 150ms ease-out; position: relative; }
        .folder-item:hover { background-color: var(--surface-hover); }
        .folder-item.active { background-color: var(--surface-hover); font-weight: 600; color: var(--text-color); }
        .folder-link { flex-grow: 1; text-decoration: none; color: inherit; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .folder-link svg { width: 16px; height: 16px; flex-shrink: 0; }
        .folder-actions { margin-left: auto; display: flex; }
        .folder-action-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; border-radius: 4px; display: flex; align-items: center; }
        .folder-action-btn svg { width: 14px; height: 14px; }
        .folder-action-btn:hover { background-color: rgba(255,255,255,0.15); }

        #folder-search-nav, #folder-search-move {
            font-family: var(--font-monospace);
        }
        .move-here-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            margin-left: auto;
            transition: all 150ms ease-out;
        }
        .move-here-btn:hover:not([disabled]) {
            background-color: var(--surface-hover);
            color: var(--accent-yellow);
        }
        .move-here-btn[disabled] {
            opacity: 0.2;
            cursor: not-allowed;
        }

        .folder-toggle { color: var(--text-muted); cursor: pointer; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .folder-toggle.empty { visibility: hidden; }
        .folder-toggle svg { transition: transform 150ms ease-out; }
        li:not(.collapsed) .folder-toggle svg { transform: rotate(90deg); }
        #create-folder-btn { width: 100%; background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 150ms ease-out; margin-top: 1.5rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        #create-folder-btn:hover { background: var(--surface-color); border-color: var(--accent-yellow); color: var(--accent-yellow); }
        #create-folder-btn svg { width: 16px; height: 16px; }
        /* ===================================
           BREADCRUMBS & HEADER CONTROLS
           =================================== */
        .breadcrumbs { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: var(--space-3); 
            padding: var(--space-3) var(--space-5); 
            background: var(--surface-color); 
            border-bottom: 1px solid var(--border-color); 
            flex-wrap: wrap; 
        }
        
        .breadcrumb-links { 
            display: flex; 
            align-items: center; 
            gap: var(--space-1); 
            flex-wrap: wrap; 
            overflow: hidden; 
            flex-grow: 1; 
        }
        
        .breadcrumb-links a, 
        .breadcrumb-links span { 
            color: var(--text-muted); 
            text-decoration: none; 
            font-weight: 500; 
            font-size: var(--text-sm);
            white-space: nowrap; 
            transition: color var(--transition-fast);
        }
        
        .breadcrumb-links a:hover { 
            color: var(--text-color); 
        }
        
        .breadcrumb-links span:last-child { 
            color: var(--text-color); 
            font-weight: 700; 
            text-overflow: ellipsis; 
            overflow: hidden; 
        }
        
        /* Gallery Sort Controls - Standardized Buttons */
        .gallery-sort-controls { 
            display: flex; 
            gap: var(--space-2); 
            flex-shrink: 0; 
        }
        
        .gallery-sort-controls .sort-btn { 
            flex-shrink: 0; 
            padding: var(--space-2) var(--space-3); 
            font-size: var(--text-sm); 
            background: transparent; 
            color: var(--text-muted); 
            font-weight: 600; 
            text-decoration: none; 
            border-radius: 4px; 
            border: 1px solid var(--border-color); 
            transition: all var(--transition-fast); 
            display: flex; 
            align-items: center; 
            gap: var(--space-1); 
            cursor: pointer;
        }
        
        .gallery-sort-controls .sort-btn:hover { 
            background: var(--surface-hover); 
            color: var(--text-color); 
            border-color: var(--text-muted); 
        }
        
        .gallery-sort-controls .sort-btn.active {
            background: var(--surface-color);
            color: var(--accent-yellow);
            border-color: var(--accent-yellow);
            font-weight: 700;
        }
        
        .gallery-sort-controls .sort-btn svg { 
            width: 16px; 
            height: 16px; 
        }
        
        /* Results Count Indicator */
        .results-count { 
            padding: var(--space-2) var(--space-3); 
            background: var(--surface-color); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: var(--text-sm);
            font-family: var(--font-monospace);
            color: var(--text-muted);
            flex-shrink: 0;
        }
        
        .results-count .count-label { 
            display: inline-block; 
        }
        
        .results-count strong { 
            color: var(--text-color); 
            font-weight: 700; 
        }

        /* ===================================
           FILTER PANEL - INKWELL DESIGN
           =================================== */
        #filter-panel { 
            position: fixed; 
            top: 0; 
            right: 0; 
            width: 450px; 
            height: 100vh; 
            background: var(--surface-color); 
            border-left: 1px solid var(--border-color); 
            transform: translateX(100%); 
            transition: transform var(--transition-base); 
            z-index: 2000; 
            display: flex; 
            flex-direction: column; 
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.4); 
        }
        
        #filter-panel.open { 
            transform: translateX(0); 
        }
        
        #filter-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: rgba(0, 0, 0, 0.6); 
            backdrop-filter: none; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity var(--transition-base); 
            z-index: 1999; 
        }
        
        #filter-backdrop.visible { 
            opacity: 1; 
            pointer-events: auto; 
        }
        
        .filter-panel-header { 
            padding: var(--space-4); 
            border-bottom: 1px solid var(--border-color); 
            background: var(--surface-hover); 
            color: var(--text-color); 
            flex-shrink: 0; 
        }
        
        .filter-panel-header h2 { 
            margin: 0; 
            font-size: var(--text-2xl); 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: var(--space-3); 
        }
        
        .filter-panel-header h2 .filter-count-badge { 
            background: var(--accent-yellow); 
            color: var(--bg-color); 
            padding: 2px var(--space-2); 
            border-radius: 4px; 
            font-size: var(--text-sm); 
            font-weight: 700; 
        }
        
        #filter-close-btn { 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            width: 36px; 
            height: 36px; 
            border-radius: 4px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            transition: all var(--transition-fast); 
        }
        
        #filter-close-btn:hover { 
            background: var(--surface-color); 
            color: var(--text-color); 
        }
        
        .filter-panel-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: var(--space-4); 
        }
        
        .filter-panel-content::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .filter-panel-content::-webkit-scrollbar-track { 
            background: var(--surface-hover); 
            border-radius: 4px; 
        }
        
        .filter-panel-content::-webkit-scrollbar-thumb { 
            background: var(--border-color); 
            border-radius: 4px; 
        }
        
        .filter-panel-content::-webkit-scrollbar-thumb:hover { 
            background: var(--text-muted); 
        }
        
        .filter-form-grid { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-4); 
        }
        
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-2);
        }
        
        /* Form Labels - Consistent styling */
        .filter-panel-content label { 
            font-weight: 700; 
            color: var(--text-muted); 
            font-size: var(--text-xs); 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            display: block;
        }
        
        /* Form Controls - Unified appearance */
        .filter-panel-content select, 
        .filter-panel-content input[type="text"], 
        .filter-panel-content input[type="number"] { 
            background: var(--bg-color); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            padding: var(--space-2) var(--space-3); 
            font-size: var(--text-sm); 
            transition: all var(--transition-fast); 
            font-family: var(--font-body);
        }
        
        .filter-panel-content input[type="text"]::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }
        
        .filter-panel-content select[multiple] { 
            min-height: 120px; 
            padding: var(--space-1);
        }
        
        .filter-panel-content select[multiple] option {
            padding: var(--space-1);
            border-radius: 4px;
            margin-bottom: 2px;
        }
        
        .filter-panel-content select[multiple] option:checked {
            background: var(--accent-yellow);
            color: var(--bg-color);
            font-weight: 600;
        }
        
        .filter-panel-content input[type="text"]:focus, 
        .filter-panel-content input[type="number"]:focus, 
        .filter-panel-content select:focus { 
            border-color: var(--accent-yellow); 
            background: var(--bg-color);
        }
        
        .filter-panel-content input[type="text"]:hover, 
        .filter-panel-content input[type="number"]:hover, 
        .filter-panel-content select:hover {
            border-color: var(--text-muted);
        }
        
        /* Number inputs - Monospace for precision */
        .filter-panel-content input[type="number"] { 
            font-variant-numeric: tabular-nums; 
            font-family: var(--font-monospace);
            letter-spacing: 0.3px;
        }
        
        .filter-panel-content input[type="number"]::-webkit-inner-spin-button, 
        .filter-panel-content input[type="number"]::-webkit-outer-spin-button { 
            opacity: 0.5;
            transition: opacity var(--transition-base);
        }
        
        .filter-panel-content input[type="number"]:hover::-webkit-inner-spin-button, 
        .filter-panel-content input[type="number"]:hover::-webkit-outer-spin-button { 
            opacity: 1; 
        }
        
        .filter-panel-footer a { 
            text-decoration: none; 
            text-align: center; 
            color: var(--text-muted); 
        }
        
        .filter-panel-footer a:hover { 
            background: var(--surface-hover); 
            color: var(--text-color); 
        }
        /* ===================================
           TOGGLE SWITCH (FAVORITES FILTER)
           =================================== */
        .filter-group-inline { 
            display: flex; 
            align-items: center;
            gap: var(--space-2); 
            margin-bottom: 0;
        }
        
        .filter-group-inline input[type="checkbox"] { 
            width: 20px; 
            height: 20px;
            accent-color: var(--accent-yellow);
            flex-shrink: 0;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .filter-group-inline label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: var(--text-sm);
            margin-bottom: 0;
            cursor: pointer;
            user-select: none;
        }

        /* Toggle Switch Container */
        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-switch-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            transition: all var(--transition-fast);
        }
        
        .toggle-switch-handle::before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            border-radius: 50%;
            transition: all var(--transition-fast);
        }
        
        .toggle-switch input:checked + .toggle-switch-handle {
            background-color: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }
        
        .toggle-switch input:checked + .toggle-switch-handle::before {
            transform: translateX(20px);
            background-color: var(--bg-color);
        }
        
        .toggle-switch:hover .toggle-switch-handle {
            border-color: var(--text-muted);
        }
        
        .toggle-switch input:checked:hover + .toggle-switch-handle {
            border-color: var(--accent-yellow);
            background-color: var(--accent-yellow);
            filter: brightness(1.1);
        }
        
        .toggle-switch-container label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: var(--text-sm);
            margin-bottom: 0;
            cursor: pointer;
            user-select: none;
        }
        
        /* ===================================
           ACTIVE FILTER PILLS
           =================================== */
        .active-filters-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: var(--space-1); 
            padding: 0; 
            border-radius: 4px; 
            margin-bottom: var(--space-4); 
        }
        
        .active-filters-container:empty { 
            display: none; 
        }
        
        .active-filter-pill { 
            display: inline-flex; 
            align-items: center; 
            gap: var(--space-1); 
            background: var(--surface-hover); 
            color: var(--text-color); 
            padding: 0.35rem var(--space-2); 
            border-radius: 4px; 
            font-size: var(--text-xs); 
            font-weight: 600; 
            cursor: pointer; 
            transition: all var(--transition-fast);
            border: 1px solid var(--border-color);
        }
        
        .active-filter-pill:hover { 
            background: var(--surface-color);
            border-color: var(--text-muted);
            color: var(--text-color);
        }
        
        .active-filter-pill .remove-icon { 
            font-size: 1rem; 
            font-weight: 700; 
            opacity: 0.7;
        }
        
        .active-filter-pill:hover .remove-icon {
            opacity: 1;
        }
        
        #clear-all-filters-btn { 
            background: var(--surface-hover); 
            color: var(--text-muted); 
            border: 1px solid var(--border-color); 
            padding: 0.35rem var(--space-2); 
            border-radius: 4px; 
            font-size: var(--text-xs); 
            font-weight: 600; 
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        #clear-all-filters-btn:hover { 
            background: var(--surface-color);
            border-color: var(--text-muted);
            color: var(--text-color);
        }
        /* ===================================
           WORKFLOW METADATA FILTERS
           =================================== */
        .workflow-filters-section { 
            display: contents; 
        }
        
        .workflow-section-header {
            margin: var(--space-4) 0 var(--space-3) 0;
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border-color);
            background: none;
            border-left: none;
            border-radius: 0;
        }
        
        .workflow-section-header h3 {
            margin: 0; 
            font-size: var(--text-xs); 
            font-weight: 700; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            display: flex; 
            align-items: center; 
            gap: var(--space-1); 
        }
        
        /* Range Filter Pairs - Improved Visual Grouping */
        .filter-range-pair { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            position: relative;
        }
        
        .filter-range-pair .filter-group { 
            position: relative; 
        }
        
        .filter-range-pair .filter-group:first-child::after { 
            content: '→'; 
            position: absolute; 
            right: calc(-1 * var(--space-2) / 2); 
            top: 50%; 
            transform: translateY(-50%) translateY(var(--space-2)); 
            color: var(--text-muted);
            font-size: 1rem; 
            font-weight: 700; 
            opacity: 0.5; 
            z-index: 1; 
            pointer-events: none; 
        }
        
        .filter-range-pair .filter-group label { 
            color: var(--text-muted); 
        }
        
        .filter-range-pair .filter-group:first-child label { 
            color: var(--text-color); 
            font-weight: 700;
        }
        
        .filter-range-pair .filter-group:last-child label { 
            color: var(--text-color); 
            font-weight: 700;
        }
        
        /* Dimension Filters - Unified with Range Pair Styling */
        .dimension-filters { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: var(--space-3) var(--space-2);
            padding: var(--space-3); 
            background: var(--bg-color); 
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .dimension-filters .filter-group label { 
            font-size: var(--text-xs);
            display: flex; 
            align-items: center; 
            gap: 0.4rem; 
        }
        /* ===================================
           FILTER PANEL FOOTER
           =================================== */
        .filter-panel-footer { 
            padding: var(--space-3) var(--space-4); 
            border-top: 1px solid var(--border-color); 
            background: var(--bg-color); 
            display: flex; 
            gap: var(--space-2); 
            flex-shrink: 0; 
        }
        
        .filter-panel-footer button { 
            flex: 1; 
            padding: var(--space-2) var(--space-4); 
            border-radius: 4px; 
            font-weight: 600; 
            font-size: var(--text-sm); 
            border: 1px solid var(--accent-yellow); 
            background: var(--accent-yellow); 
            color: var(--bg-color); 
            cursor: pointer; 
            transition: all var(--transition-fast); 
        }
        
        .filter-panel-footer button:hover { 
            background: transparent; 
            color: var(--accent-yellow); 
        }
        
        .filter-panel-footer a { 
            flex: 0.5; 
            padding: var(--space-2) var(--space-4); 
            border-radius: 4px; 
            font-weight: 600; 
            font-size: var(--text-sm); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid var(--border-color); 
            background: var(--surface-color); 
            color: var(--text-muted); 
            text-decoration: none; 
            transition: all var(--transition-fast); 
        }
        
        .filter-panel-footer a:hover { 
            background: var(--surface-hover); 
            color: var(--text-color); 
            border-color: var(--text-muted); 
        }
        
        .filter-actions-row { 
            display: flex; 
            gap: var(--space-2); 
            flex-wrap: wrap; 
        }
        
        .filter-actions-row > a, 
        .filter-actions-row > button { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .filter-actions-row button[type="submit"] { 
            padding-left: var(--space-2); 
            padding-right: var(--space-2); 
        }
        
        .mobile-actions-row { 
            display: flex; 
            gap: var(--space-2); 
        }
        
        .mobile-actions-row > * { 
            flex-grow: 1; 
            text-align: center; 
            justify-content: center; 
        }
        
        .mobile-actions-row button { 
            padding-left: var(--space-2); 
            padding-right: var(--space-2); 
        }

        /* ===================================
           TOM-SELECT DROPDOWN THEMING
           =================================== */
        .ts-wrapper { 
            width: 100%; 
        }
        
        .ts-control { 
            background: var(--bg-color) !important; 
            border: 1px solid var(--border-color) !important; 
            border-radius: 4px !important; 
            padding: var(--space-2) var(--space-3) !important;
            box-shadow: none !important;
            transition: all var(--transition-fast) !important;
        }
        
        .ts-control, 
        .ts-control input { 
            color: var(--text-color) !important; 
            font-size: var(--text-sm) !important; 
            font-family: var(--font-monospace) !important;
        }

        .ts-control input::placeholder {
            color: var(--text-muted) !important;
            opacity: 0.7 !important;
        }
        
        /* Tom-Select Hover State */
        .ts-wrapper:not(.focus) .ts-control:hover {
            border-color: var(--text-muted) !important;
        }
        
        /* Tom-Select Dropdown Menu */
        .ts-dropdown {
            background: var(--surface-hover) !important; 
            border: 1px solid var(--border-color) !important; 
            border-radius: 4px !important; 
            box-shadow: var(--shadow-md) !important;
            margin-top: 4px !important;
            z-index: 1000 !important;
        }
        
        .ts-dropdown-content {
            color: var(--text-color) !important;
            max-height: 240px !important;
        }
        
        /* Tom-Select Options */
        .ts-dropdown .option, 
        .ts-dropdown .optgroup-header, 
        .ts-dropdown .no-results, 
        .ts-dropdown .create {
            background: transparent !important;
            color: var(--text-color) !important;
            padding: var(--space-2) var(--space-3) !important;
            border-bottom: none !important;
            font-size: var(--text-sm) !important;
        }
        
        .ts-dropdown .option:hover, 
        .ts-dropdown .option.active {
            background: var(--surface-color) !important;
            color: var(--text-color) !important;
        }
        
        .ts-dropdown .option.selected {
            background: var(--bg-color) !important;
            color: var(--accent-yellow) !important;
            font-weight: 600 !important;
        }
        
        .ts-dropdown .option.selected:hover {
            background: var(--bg-color) !important;
        }
        
        /* Tom-Select Selected Items (Multi-select Pills) */
        .ts-control .item {
            background: transparent !important;
            color: var(--text-color) !important;
            padding: 0 var(--space-1) 0 0 !important;
            margin: 0 !important;
            font-size: var(--text-sm) !important;
            font-weight: 500 !important;
            border-right: 1px solid var(--border-color);
            margin-right: var(--space-1) !important;
        }

        .ts-control .item .remove {
            color: var(--text-muted) !important;
            border: none !important;
            padding: 0 !important;
            margin-left: 0.25rem !important;
            font-size: 1rem !important;
            font-weight: 700 !important;
            opacity: 0.7 !important;
            text-decoration: none !important;
            transition: all var(--transition-fast) !important;
        }
        
        .ts-control .item .remove:hover {
            background: none !important;
            color: var(--text-color) !important;
            opacity: 1 !important;
        }
        
        /* Tom-Select Focus State */
        .ts-wrapper.focus .ts-control {
            border-color: var(--accent-yellow) !important;
            box-shadow: none !important;
        }
        
        /* Tom-Select Optgroup Headers */
        .ts-dropdown .optgroup-header {
            background: var(--bg-color) !important;
            color: var(--text-muted) !important;
            font-weight: 700 !important;
            font-size: var(--text-xs) !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 1 !important;
        }
        
        /* Tom-Select No Results */
        .ts-dropdown .no-results {
            color: var(--text-muted) !important;
            font-style: italic !important;
            font-size: var(--text-sm) !important;
        }
        
        /* ===================================
           GALLERY GRID & CARDS
           =================================== */
        #gallery-anchor { 
            display: block; 
            position: relative; 
            top: -20px; 
            visibility: hidden; 
        }
        
        .gallery-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: var(--space-5); 
            padding: var(--space-5); 
            min-height: 50vh; 
        }
        
        /* Gallery Cards - Inkwell Design */
        .gallery-item {
            background-color: var(--surface-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-shadow: none;
            transition: all var(--transition-fast);
            backdrop-filter: none;
            display: flex;
            flex-direction: column;
        }
        
        .gallery-item:hover {
            transform: none;
            border-color: var(--text-muted);
            box-shadow: var(--shadow-sm);
        }
        
        .gallery-item.selected {
            border-color: var(--accent-yellow);
            box-shadow: inset 0 0 0 1px var(--accent-yellow);
        }

        .thumbnail-link { 
            cursor: pointer; 
        }
        
        .thumbnail-wrapper { 
            position: relative; 
            width: 100%; 
            background: var(--bg-color); 
            overflow: hidden; 
            border-radius: 4px 4px 0 0;
        }
        
        .thumbnail-wrapper img, 
        .thumbnail-wrapper video { 
            display: block; 
            width: 100%; 
            height: auto; 
            transition: transform var(--transition-slow); 
        }
        
        .gallery-item:hover .thumbnail-wrapper img, 
        .gallery-item:hover .thumbnail-wrapper video { 
            transform: scale(1.05); 
        }
        
        /* Active/click animation for gallery items */
        .gallery-item:active {
            transform: scale(0.98);
        }
        
        .gallery-item:active .thumbnail-wrapper img,
        .gallery-item:active .thumbnail-wrapper video {
            transform: scale(1.02);
        }
        
        /* Card Content - Information Hierarchy */
        .item-info { 
            padding: var(--space-3); 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            gap: var(--space-2);
        }
        
        /* Prompt Preview - Primary Information */
        .prompt-preview {
            font-size: var(--text-sm);
            color: var(--text-color);
            line-height: 1.5;
            margin-bottom: var(--space-1);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        /* Filename - Secondary Information */
        .item-filename {
            font-weight: 600;
            color: var(--text-muted);
            word-break: break-all;
            font-family: var(--font-monospace);
            font-size: var(--text-xs);
            letter-spacing: 0.02em;
        }
        
        /* Metadata Grid - Tertiary Information */
        .item-metadata {
            font-family: var(--font-monospace);
            font-size: var(--text-xs);
            color: var(--text-muted);
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.15rem var(--space-1);
        }
        
        .item-metadata span { 
            display: inline-flex; 
            align-items: center; 
            gap: 0.3rem; 
        }
        
        .item-metadata .label { 
            grid-column: 1; 
            opacity: 0.7;
        }
        
        .item-metadata .value { 
            grid-column: 2; 
            font-weight: 500;
        }

        /* ===================================
           SELECTION OVERLAY & CHECKBOX
           =================================== */
        .selection-overlay {
            position: absolute;
            top: var(--space-2);
            left: var(--space-2);
            cursor: pointer;
            z-index: 12;
        }
        
        .selection-checkbox {
            width: 20px;
            height: 20px;
            background: rgba(18, 18, 18, 0.85);
            border: 2px solid var(--border-color);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .gallery-item:hover .selection-checkbox {
            border-color: var(--text-muted);
            background: rgba(18, 18, 18, 0.95);
        }
        
        .gallery-item.selected .selection-checkbox {
            background: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }
        
        .selection-checkbox::after {
            content: '✓';
            color: var(--bg-color);
            font-size: 14px;
            font-weight: bold;
            transform: scale(0);
            opacity: 0;
            transition: all var(--transition-fast);
        }
        
        .gallery-item.selected .selection-checkbox::after {
            transform: scale(1);
            opacity: 1;
        }

        /* ===================================
           ITEM ACTION BUTTONS
           =================================== */
        .item-actions-container {
            display: flex;
            gap: 0;
            margin-top: auto;
            align-items: center;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: var(--space-2);
        }
        
        .item-action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: var(--space-1) var(--space-2);
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            position: relative;
        }
        
        .item-action-btn:hover {
            background: var(--surface-hover);
            color: var(--text-color);
        }
        
        .item-action-btn.favorited {
            color: var(--accent-yellow);
        }
        
        .item-action-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .item-action-btn:last-of-type {
            margin-left: auto;
            flex: 0;
            padding: var(--space-1);
        }
        
        /* Tooltip for icon buttons (accessibility) */
        .item-action-btn::before {
            content: attr(aria-label);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-color);
            color: var(--text-color);
            padding: var(--space-1) var(--space-2);
            border-radius: 4px;
            font-size: var(--text-xs);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            z-index: 100;
            margin-bottom: 4px;
            border: 1px solid var(--border-color);
        }
        
        .item-action-btn:hover::before {
            opacity: 1;
        }

        /* ===================================
           OVERLAYS & BADGES
           =================================== */
        
        /* Duration Overlay - Subtle Inkwell Style */
        .duration-overlay { 
            position: absolute; 
            bottom: var(--space-2); 
            right: var(--space-2); 
            background: rgba(0,0,0,0.9); 
            color: white; 
            padding: 2px var(--space-1); 
            border-radius: 2px; 
            font-size: var(--text-xs); 
            font-family: var(--font-monospace); 
            font-weight: 500; 
            backdrop-filter: blur(10px); 
            z-index: 10; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Workflow Badge - Monochrome with Yellow Accent */
        .workflow-badge { 
            position: absolute; 
            top: var(--space-2); 
            right: var(--space-2); 
            background: var(--text-muted); 
            color: var(--bg-color); 
            padding: 2px var(--space-2); 
            border-radius: 4px; 
            font-size: var(--text-xs); 
            text-decoration: none; 
            font-weight: 700; 
            transition: all var(--transition-fast); 
            display: flex; 
            align-items: center; 
            gap: 0.25rem; 
            z-index: 11;
        }
        
        .workflow-badge:hover { 
            background: var(--text-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        /* Multi-sampler badge uses accent color */
        .workflow-badge[data-sampler-count="2"],
        .workflow-badge[data-sampler-count="3"],
        .workflow-badge[data-sampler-count="4"],
        .workflow-badge[data-sampler-count="5"],
        .workflow-badge[data-sampler-count="6"],
        .workflow-badge[data-sampler-count="7"],
        .workflow-badge[data-sampler-count="8"],
        .workflow-badge[data-sampler-count="9"] { 
            background: var(--accent-yellow);
            color: var(--bg-color);
        }
        
        .workflow-badge[data-sampler-count="2"]:hover,
        .workflow-badge[data-sampler-count="3"]:hover,
        .workflow-badge[data-sampler-count="4"]:hover,
        .workflow-badge[data-sampler-count="5"]:hover,
        .workflow-badge[data-sampler-count="6"]:hover,
        .workflow-badge[data-sampler-count="7"]:hover,
        .workflow-badge[data-sampler-count="8"]:hover,
        .workflow-badge[data-sampler-count="9"]:hover { 
            background: var(--accent-yellow);
            filter: brightness(1.1);
        }
        /* Sampler Panel Styles */
        .lightbox-sampler-panel { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 800px; z-index: 2003; background: rgba(0, 0, 0, 0.85); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(20px); overflow: hidden; }
        .sampler-toggle-btn { width: 100%; padding: 1rem 1.5rem; background: transparent; border: none; color: white; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s; }
        .sampler-toggle-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .toggle-icon { font-size: 0.9rem; transition: transform 0.3s; }
        .sampler-toggle-btn.expanded .toggle-icon { transform: rotate(180deg); }
        .sampler-badge { margin-left: auto; background: var(--accent-yellow); color: var(--bg-color); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 700; }
        .sampler-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 0 1.5rem; }
        .sampler-content.expanded { max-height: min(500px, calc(100vh - 250px)); overflow-y: auto; padding: 0 1.5rem 1.5rem; }
        .sampler-item { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
        .sampler-item:last-child { margin-bottom: 0; }
        .sampler-header { font-size: 1.1rem; font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .sampler-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; }
        .sampler-field { display: flex; flex-direction: column; gap: 0.25rem; }
        .sampler-field-label { font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px; }
        .sampler-field-value { font-size: 1rem; color: white; font-weight: 500; font-family: var(--font-monospace); background: rgba(0, 0, 0, 0.3); padding: 0.4rem 0.6rem; border-radius: 4px; }
        .sampler-prompts { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .sampler-prompt-label { font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.4rem; font-weight: 600; }
        .sampler-prompt-text { font-size: 0.85rem; color: rgba(255, 255, 255, 0.9); background: rgba(0, 0, 0, 0.3); padding: 0.6rem; border-radius: 4px; line-height: 1.5; max-height: 100px; overflow-y: auto; }
        .sampler-loader { padding: 2rem; text-align: center; color: rgba(255, 255, 255, 0.6); }
        .sampler-error { padding: 1rem; color: var(--danger-color); text-align: center; }
        
        /* ===================================
           LOADING SKELETONS & ANIMATIONS
           =================================== */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--surface-color) 0%,
                var(--surface-hover) 50%,
                var(--surface-color) 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
            border-radius: 4px;
        }
        
        .skeleton-card {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
        }
        
        .skeleton-text {
            height: 1rem;
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .skeleton-text-short {
            height: 1rem;
            width: 60%;
            margin: 0.5rem 0;
        }
        
        /* Image lazy loading - fade in effect */
        .gallery-item img[loading="lazy"] {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        
        .gallery-item img[loading="lazy"].loaded {
            opacity: 1;
        }
        
        /* Smooth transitions for interactive elements */
        .gallery-item,
        .folder-item,
        .item-action-btn,
        .workflow-badge {
            transition: all var(--transition-fast);
        }
        
        /* Pulse animation for loading states */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Progress indicator improvements */
        .progress-bar {
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            animation: progress-shine 2s infinite;
        }
        
        @keyframes progress-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        #selection-bar { position: fixed; bottom: 0; transform: translateY(100%); transition: transform 200ms ease-out; left: 320px; right: 0; background: var(--surface-color); border-top: 1px solid var(--border-color); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; z-index: 1001; box-sizing: border-box; backdrop-filter: none; flex-wrap: wrap; }
        body.sidebar-expanded #selection-bar { left: 600px; }
        #selection-bar.visible { transform: translateY(0); }
        #selection-bar button { padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--surface-hover); color: var(--text-color); cursor: pointer; transition: all 150ms ease-out; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        #selection-bar button:hover { background: var(--surface-color); border-color: var(--text-muted); }
        #selection-bar button svg { width: 16px; height: 16px; }
        #selection-bar .delete-btn { background: var(--danger-color); }
        #selection-counter { font-weight: 700; margin-right: auto; padding-left: 1rem; color: var(--accent-yellow); }
        #drag-drop-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 1002; display: none; opacity: 0; transition: opacity 150ms ease-out; backdrop-filter: none; }
        #drag-drop-overlay.visible { display: block; opacity: 1; }
        #drop-zone-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; z-index: 1003; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: var(--shadow-lg); display: none; flex-direction: column; max-height: 80vh; }
        #drop-zone-panel.visible { display: flex; }
        #drop-zone-panel h3 { margin: 0; padding: 1rem 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); font-weight: 600; flex-shrink: 0;}
        #drop-zone-folders { overflow-y: auto; display: flex; flex-direction: column; padding: 0; min-height: 0; flex-grow: 1; }
        #cancel-drop-btn { background: var(--danger-color); color: white; border: none; padding: 1rem; cursor: pointer; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; font-weight: 600; transition: background-color 150ms ease-out; flex-shrink: 0;}
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 200ms ease-out; }
        .loader { border: 4px solid var(--surface-color); border-top: 4px solid var(--accent-yellow); border-radius: 50%; width: 48px; height: 48px; animation: spin 1.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #lightbox-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(18,18,18,0.95); backdrop-filter: none; z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 200ms ease-out; }
        #lightbox-overlay.visible { opacity: 1; pointer-events: auto; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: 1px solid var(--border-color); border-radius: 50%; width: 60px; height: 60px; font-size: 1.8rem; cursor: pointer; transition: all 150ms ease-out; display: flex; justify-content: center; align-items: center; backdrop-filter: none; z-index: 2001; }
        .lightbox-nav:hover { background: rgba(0,0,0,0.8); }
        #lightbox-prev { left: 30px; }
        #lightbox-next { right: 30px; }
        #lightbox-header { position: absolute; top: 0; left: 0; right: 0; z-index: 2002; padding: 1rem; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%); backdrop-filter: none; display: flex; flex-direction: column; gap: 1rem; align-items: center; text-align: center; }
        #lightbox-title { font-size: 1.1rem; font-weight: 600; color: white; word-break: break-word; hyphens: auto; max-width: 90vw; }
        #lightbox-toolbar { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.75rem; }
        #lightbox-toolbar button, #lightbox-toolbar a { background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); color: var(--text-muted); padding: 0.75rem; border-radius: 4px; font-size: 1.2rem; cursor: pointer; transition: all 150ms ease-out; text-decoration: none; display: flex; align-items: center; justify-content: center; min-width: 44px; height: 44px; backdrop-filter: none; }
        #lightbox-toolbar button:hover, #lightbox-toolbar a:hover { background: rgba(255,255,255,0.2); color: var(--text-color); }
        #lightbox-toolbar button svg, #lightbox-toolbar a svg { width: 20px; height: 20px; }
        #lightbox-content { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 6rem 1rem 2rem; }
        #lightbox-media { display: flex; align-items: center; justify-content: center; max-width: 95vw; max-height: 90vh; }
        #lightbox-media img, #lightbox-media video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 12px; box-shadow: var(--shadow-lg); cursor: grab; }
        #backToTopBtn { display: none; position: fixed; bottom: 110px; right: 30px; z-index: 99; font-size: 1.2rem; border: none; background: var(--accent-yellow); color: var(--bg-color); cursor: pointer; padding: 12px 16px; border-radius: 4px; transition: all 150ms ease-out; box-shadow: var(--shadow-md); }
        #load-more-container { text-align: center; padding: 3rem; }
        #load-more-btn { background: var(--surface-hover); border: 1px solid var(--border-color); color: var(--text-color); padding: 1rem 2.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 150ms ease-out; }
        #load-more-btn:hover { border-color: var(--accent-yellow); color: var(--accent-yellow); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
        #node-summary-overlay, #upload-overlay, #sync-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); backdrop-filter: none; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 150ms ease-out; }
        #node-summary-overlay { z-index: 2100; }
        #upload-overlay { z-index: 2200; }
        #sync-overlay { z-index: 2300; display: none; opacity: 1; pointer-events: all;}
        #node-summary-overlay.visible, #upload-overlay.visible { opacity: 1; pointer-events: auto; }
        .node-summary-panel, #upload-panel, #sync-panel { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: var(--shadow-lg); width: 90vw; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 150ms ease-out; }
        .node-summary-panel { max-width: 900px; max-height: 85vh; }
        #upload-panel { max-width: 600px; max-height: 85vh; }
        #sync-panel { max-width: 500px; padding: 2rem; align-items: center; text-align: center; border-radius: 4px; }
        #node-summary-overlay.visible .node-summary-panel, #upload-overlay.visible #upload-panel { transform: scale(1); }
        .node-summary-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--surface-color); }
        .node-summary-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .node-summary-header .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; padding: 0; line-height: 1; }
        #node-summary-content { padding: 1.5rem; overflow-y: auto; }
        .summary-node-item { margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .summary-node-header { color: white; padding: 0.75rem 1rem; font-weight: bold; font-size: 0.9rem; }
        .summary-node-header small { opacity: 0.8; font-weight: normal; margin-left: 0.5rem; }
        .summary-node-params { list-style: none; margin: 0; padding: 1rem; background: var(--glass-bg); }
        .summary-node-params li { padding: 0.5rem 0; font-size: 1rem; border-bottom: 1px solid var(--glass-border); }
        .summary-node-params li:last-child { border-bottom: none; }
        .summary-node-params strong { color: var(--text-color); margin-right: 0.5rem; }
        .summary-node-params code { color: var(--text-muted); word-break: break-all; white-space: pre-wrap; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; }
        #refresh-btn { margin-left: auto; }
        .upload-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); text-align: center; }
        .upload-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .upload-header p { margin: 0.5rem 0 0; color: var(--text-muted); }
        .upload-body { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        #drop-zone { border: 2px dashed var(--border-color); border-radius: 4px; padding: 2rem; text-align: center; color: var(--text-muted); transition: all 150ms ease-out; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; }
        #drop-zone.dragover { border-color: var(--accent-yellow); background: var(--surface-hover); transform: none; }
        #drop-zone p { font-size: 1.1rem; font-weight: 500; margin: 0 0 1rem 0; }
        #file-upload-btn { background: var(--accent-yellow); color: var(--bg-color); font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; cursor: pointer; }
        #file-list { list-style: none; padding: 0; margin-top: 1.5rem; max-height: 200px; overflow-y: auto; }
        #file-list li { background: var(--bg-color); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .file-size { color: var(--text-muted); font-size: 0.8rem; }
        .upload-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; }
        .upload-footer button { padding: 0.75rem 1.5rem; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; }
        #upload-cancel-btn { background: var(--surface-hover); color: var(--text-color); }
        #upload-submit-btn { background: var(--accent-yellow); color: var(--bg-color); }
        #upload-progress-container { display: none; margin-top: 1rem; }
        #upload-progress-bar { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        #upload-progress-fill { width: 0%; height: 100%; background: var(--accent-yellow); transition: width 0.2s; }
        #upload-file-input { display: none; }
        #sync-message { margin: 0 0 1rem; font-size: 1.1rem; font-weight: 500; }
        #sync-progress-bar { width: 100%; height: 10px; background-color: var(--border-color); border-radius: 5px; overflow: hidden; }
        #sync-progress-fill { width: 0%; height: 100%; background-color: var(--accent-yellow); transition: width 200ms linear; }
        #mobile-filter-toggle { display: none; width: 100%; background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; text-align: left; }
        .mobile-actions-only { display: none; }
        @media (max-width: 1024px) {
            body.sidebar-expanded-mobile .sidebar { position: fixed; width: 100%; min-width: 100%; height: 100%; top: 0; left: 0; transform: translateX(0); z-index: 1005; }
            body.sidebar-expanded-mobile .main-content { display: none; }
            body:not(.sidebar-expanded-mobile) { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: static; border-right: none; border-bottom: 1px solid var(--border-color); }
            #selection-bar { left: 0; }
            body.sidebar-expanded #selection-bar { left: 0; }
            #sidebar-toggle-btn { display: flex; }
            #sidebar-expand-btn { display: none; }
            .sidebar.nav-collapsed .folder-controls, .sidebar.nav-collapsed .folder-tree-container, .sidebar.nav-collapsed #create-folder-btn { display: none; }
        }
        @media (max-width: 768px) {
            .breadcrumbs { flex-direction: column; align-items: stretch; }
            .gallery-sort-controls { justify-content: space-around; width: 100%; }
            .filter-bar form { grid-template-columns: 1fr; }
            
            /* Mobile: Bottom Sheet Style */
            #filter-panel { width: 100%; height: 75vh; top: auto; bottom: 0; transform: translateY(100%); border-left: none; border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; }
            #filter-panel.open { transform: translateY(0); }
            .filter-panel-header { border-radius: 20px 20px 0 0; position: relative; }
            .filter-panel-header::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; }
            
            .filter-range-pair { grid-template-columns: 1fr; gap: 1rem; }
            .filter-range-pair .filter-group:first-child::after { display: none; }
            .dimension-filters { grid-template-columns: 1fr; gap: 1rem; }
            .workflow-section-header { margin-top: 0.5rem; padding: 0.5rem 0.75rem; }
            .workflow-section-header h3 { font-size: 0.85rem; }
            .desktop-actions-only { display: none; }
            .mobile-actions-only { display: flex; flex-direction: column; gap: 0.75rem; }
            .gallery-container { grid-template-columns: 1fr; padding: 1rem; }
            #selection-bar { flex-direction: column; align-items: stretch; gap: 0.5rem; padding: 1rem; }
            #selection-bar .actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; width: 100%; }
            #selection-bar > #select-all-btn, #selection-bar > #deselect-all-btn { grid-column: span 2; }
            #selection-counter { text-align: center; padding-left: 0; margin-bottom: 0.5rem; }
            #drop-zone-panel { width: 90vw; }
            .lightbox-nav { width: 50px; height: 50px; }
            #lightbox-prev { left: 10px; }
            #lightbox-next { right: 10px; }
            .node-summary-panel { width: 95vw; max-height: 90vh; }
            .summary-node-params li { font-size: 0.9rem; }
        }
        @media (min-width: 1025px) {
            #drop-zone-panel { width: 650px; max-width: 90vw; }
        }
    </style>
</head>
<body x-data="gallery()" 
    @keydown.escape.window="handleEscape()" 
    @keydown.ctrl.a.window.prevent="selectAll()"
    @keydown.window="if ($event.key === '?' && shouldShowHelp()) { $event.preventDefault(); isHelpOpen = true; }"
    @resize.window.debounce.150ms="handleResize()"
    @scroll.window.debounce.150ms="shouldShowBackToTop = window.scrollY > 300"
      :class="{ 
          'lightbox-open': isLightboxOpen, 
          'modal-open': isUploadOpen || isSummaryOpen || isHelpOpen,
          'sidebar-expanded': sidebarExpanded
      }">
    <div id="notification-container">
        <template x-for="notification in $store.notifications.list" :key="notification.id">
            <div class="notification show"
                 :class="notification.type"
                 x-transition:enter="transition ease-out duration-500"
                 x-transition:enter-start="opacity-0 translate-x-full"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-500"
                 x-transition:leave-start="opacity-100 translate-x-0"
                 x-transition:leave-end="opacity-0 translate-x-full">
                <span x-text="notification.message"></span>
            </div>
        </template>
    </div>
    <!-- Hidden, Alpine-managed drag image element for native Drag & Drop API -->
    <div x-ref="dragImage" x-text="dragImageLabel" aria-hidden="true" style="position: absolute; top: -1000px; left: -1000px; background: var(--accent-yellow); color: var(--bg-color); padding: 8px 16px; border-radius: 4px; font-weight: 700; pointer-events: none;"> </div>
    <aside class="sidebar" :class="{ 'nav-collapsed': isMobileView && isMobileNavCollapsed }">
        <div class="sidebar-header">
            <a href="{{ url_for('gallery_view', folder_key='_root_') }}" style="text-decoration: none;"><h1>SmartGallery</h1></a>
            <div class="sidebar-actions">
                <!-- Expand button is removed in Inkwell UI -->
                <button id="sidebar-toggle-btn" 
                        x-show="isMobileView" 
                        @click="isMobileNavCollapsed = !isMobileNavCollapsed"
                        style="display: none;">
                    <span>☰</span>
                    <span id="sidebar-toggle-text" 
                          x-text="isMobileNavCollapsed ? 'Show Folders' : 'Hide Folders'">
                    </span>
                </button>
            </div>
        </div>
        <div class="folder-controls">
            <input type="search" 
                   class="folder-search-input"
                   id="folder-search-nav" 
                   placeholder="Search folders..."
                   x-model.debounce.300ms="$store.gallery.folderSearchTerm">
            <div class="folder-sort-buttons" id="folder-sort-nav">
                <button @click="$store.gallery.folderSort = { key: 'name', dir: $store.gallery.folderSort.key === 'name' && $store.gallery.folderSort.dir === 'asc' ? 'desc' : 'asc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'name' }"
                        :title="'Sort by name ' + ($store.gallery.folderSort.key === 'name' ? ($store.gallery.folderSort.dir === 'asc' ? '↓' : '↑') : '')"
                        x-text="'A-Z' + ($store.gallery.folderSort.key === 'name' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')">A-Z</button>
                <button @click="$store.gallery.folderSort = { key: 'mtime', dir: $store.gallery.folderSort.key === 'mtime' && $store.gallery.folderSort.dir === 'desc' ? 'asc' : 'desc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'mtime' }"
                        :title="'Sort by date ' + ($store.gallery.folderSort.key === 'mtime' ? ($store.gallery.folderSort.dir === 'asc' ? '↓' : '↑') : '')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span x-text="($store.gallery.folderSort.key === 'mtime' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')"></span>
                </button>
            </div>
        </div>
        <div class="folder-tree-container">
            <ul class="folder-tree">
                <!-- Start the recursion by looping over the root node's children -->
                <template x-for="folderKey in $store.gallery.folders['_root_'].children" :key="folderKey">
                    <!-- Each top-level folder becomes a self-contained, recursive component -->
                    <li x-data="folderNode(folderKey)" x-show="isVisible" :class="{ 'collapsed': !isOpen }">
                        <div class="folder-item" :class="{ 'active': key === $store.gallery.currentFolderKey }">
                            <span class="folder-toggle" :class="{ 'empty': !folder.children || folder.children.length === 0 }" @click.stop="toggle()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                            <!-- Folder link -->
                            <a class="folder-link" :href="`/galleryout/view/${key}`" :title="folder.display_name">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                <span x-text="folder.display_name"></span>
                            </a>
                            <!-- Action buttons (rename/delete) -->
                            <template x-if="key !== '_root_' && !$store.gallery.protectedFolderKeys.includes(key)">
                                <div class="folder-actions">
                                    <button class="folder-action-btn" title="Rename" @click.stop="renameFolder(key, folder.display_name)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                    <button class="folder-action-btn" title="Delete" @click.stop="deleteFolder(key, folder.display_name)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                </div>
                            </template>
                        </div>
                        
                        <!-- RECURSION HAPPENS HERE: Children UL -->
                        <ul x-show="isOpen" x-collapse>
                            <template x-for="childKey in filteredAndSortedChildren" :key="childKey" >
                                <!-- Nested folderNode component for recursion -->
                                <li x-data="folderNode(childKey)" x-show="isVisible" :class="{ 'collapsed': !isOpen }" style="padding-left: 20px;">
                                    <div class="folder-item" :class="{ 'active': key === $store.gallery.currentFolderKey }">
                                        <span class="folder-toggle" :class="{ 'empty': !folder.children || folder.children.length === 0 }" @click.stop="toggle()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                                        <a class="folder-link" :href="`/galleryout/view/${key}`" :title="folder.display_name">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                            <span x-text="folder.display_name"></span>
                                        </a>
                                        <template x-if="key !== '_root_' && !$store.gallery.protectedFolderKeys.includes(key)">
                                            <div class="folder-actions">
                                                <button class="folder-action-btn" title="Rename" @click.stop="renameFolder(key, folder.display_name)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                                <button class="folder-action-btn" title="Delete" @click.stop="deleteFolder(key, folder.display_name)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Third level nesting (sufficient for most use cases) -->
                                    <ul x-show="isOpen" x-collapse>
                                        <template x-for="grandchildKey in filteredAndSortedChildren" :key="grandchildKey">
                                            <li x-data="folderNode(grandchildKey)" x-show="isVisible" :class="{ 'collapsed': !isOpen }" style="padding-left: 20px;">
                                                <div class="folder-item" :class="{ 'active': key === $store.gallery.currentFolderKey }">
                                                    <span class="folder-toggle" :class="{ 'empty': !folder.children || folder.children.length === 0 }" @click.stop="toggle()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                                                    <a class="folder-link" :href="`/galleryout/view/${key}`" :title="folder.display_name">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                                        <span x-text="folder.display_name"></span>
                                                    </a>
                                                    <template x-if="key !== '_root_' && !$store.gallery.protectedFolderKeys.includes(key)">
                                                        <div class="folder-actions">
                                                            <button class="folder-action-btn" title="Rename" @click.stop="renameFolder(key, folder.display_name)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                                            <button class="folder-action-btn" title="Delete" @click.stop="deleteFolder(key, folder.display_name)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </li>
                                        </template>
                                    </ul>
                                </li>
                            </template>
                        </ul>
                    </li>
                </template>
            </ul>
        </div>
        <button id="create-folder-btn" @click="createFolder()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Create New Folder
        </button>
    </aside>
    <div class="main-content">
        <header class="breadcrumbs">
            <div class="breadcrumb-links">
                {% for crumb in breadcrumbs %}
                    <a href="{{ url_for('gallery_view', folder_key=crumb.key) }}">{{ crumb.display_name }}</a>
                    {% if not loop.last %}<span>/</span>{% endif %}
                {% endfor %}
            </div>
            <div class="gallery-sort-controls">
                {% set current_sort_by = request.args.get('sort_by', 'date') %}
                {% set current_sort_order = request.args.get('sort_order', 'desc') %}
                {% set date_is_active = current_sort_by == 'date' %}
                {% set date_next_order = 'asc' if date_is_active and current_sort_order == 'desc' else 'desc' %}
                {% set date_query_params = dict(request.args.to_dict(flat=False), sort_by='date', sort_order=date_next_order) %}
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **date_query_params) }}" class="sort-btn {{ 'active' if date_is_active else '' }}" title="Sort by Date">
                    Sort by Date {% if date_is_active %}<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; transform: rotate({{ '0' if current_sort_order == 'asc' else '180' }}deg);"><path d="M12 19V5M5 12l7-7 7 7"/></svg>{% endif %}
                </a>
                {% set name_is_active = current_sort_by == 'name' %}
                {% set name_next_order = 'desc' if name_is_active and current_sort_order == 'asc' else 'asc' %}
                {% set name_query_params = dict(request.args.to_dict(flat=False), sort_by='name', sort_order=name_next_order) %}
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **name_query_params) }}" class="sort-btn {{ 'active' if name_is_active else '' }}" title="Sort by Name">
                    Sort by Name {% if name_is_active %}<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; transform: rotate({{ '0' if current_sort_order == 'asc' else '180' }}deg);"><path d="M12 19V5M5 12l7-7 7 7"/></svg>{% endif %}
                </a>
                <button type="button" class="sort-btn" @click="isFilterPanelOpen = true" :class="{ 'active': isFilterPanelOpen || activeFilterCount > 0 }">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    <span>Filters</span>
                </button>
                <button type="button" class="sort-btn" @click="isUploadOpen = true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Upload</button>
                <button type="button" class="sort-btn" @click="startSyncProcess(true)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Refresh
                </button>
                <button type="button" class="sort-btn" @click="isHelpOpen = true" title="Keyboard Shortcuts">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Help
                </button>
            </div>
            
            <!-- Results Count Indicator -->
            <div class="results-count" x-show="totalFiles > 0">
                <span class="count-label">
                    <template x-if="filesOnPage.length < totalFiles">
                        <span>Showing <strong x-text="filesOnPage.length"></strong> of <strong x-text="totalFiles"></strong> files</span>
                    </template>
                    <template x-if="filesOnPage.length === totalFiles">
                        <span><strong x-text="totalFiles"></strong> file<span x-show="totalFiles !== 1">s</span></span>
                    </template>
                </span>
            </div>
        </header>
        
        <!-- Filter Panel (Slide-out) -->
        <div id="filter-backdrop" x-show="isFilterPanelOpen" @click="isFilterPanelOpen = false" x-transition:enter="transition ease-out duration-400" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-400" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"></div>
        <div id="filter-panel" :class="{ 'open': isFilterPanelOpen }">
            <div class="filter-panel-header">
                <h2>
                    <span>Filters & Options</span>
                    <span>
                        <span class="filter-count-badge" x-show="activeFilterCount > 0" x-text="activeFilterCount + ' Active'"></span>
                        <button type="button" id="filter-close-btn" @click="isFilterPanelOpen = false">&times;</button>
                    </span>
                </h2>
            </div>
            <div class="filter-panel-content">
                <form method="GET" action="{{ url_for('gallery_view', folder_key=current_folder_key) }}" id="filter-form" @submit.prevent="applyFilters()">
                    <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by', 'date') }}">
                    <input type="hidden" name="sort_order" value="{{ request.args.get('sort_order', 'desc') }}">
                    
                    <!-- Active Filters Display -->
                    <div class="active-filters-container" id="active-filters-display">
                        <template x-for="pill in activeFilterPills" :key="pill.key">
                            <span class="active-filter-pill" @click="pill.action()">
                                <span x-text="pill.label"></span>
                                <span class="remove-icon">×</span>
                            </span>
                        </template>
                        <template x-if="activeFilterPills.length > 0">
                            <button type="button" id="clear-all-filters-btn" @click="clearAllFilters()">🔄 Clear All</button>
                        </template>
                    </div>
                    
                    <div class="filter-form-grid" id="filter-form-grid">
                    <!-- Basic Filters -->
                    <div class="filter-group"><label for="search-input">Search by Name</label><input type="text" name="search" id="search-input" placeholder="Search files..." x-model.debounce.300ms="filters.search"></div>
                    <div class="filter-group"><label for="extension-select">Extensions</label><select name="extension" id="extension-select" multiple x-model="filters.extensions" x-tom-select x-ref="extensionsSelect" placeholder="Select extensions...">{% for ext in available_extensions %}<option value="{{ ext }}" {% if ext in selected_extensions %}selected{% endif %}>{{ ext }}</option>{% endfor %}</select></div>
                    <div class="filter-group"><label for="prefix-select">Prefixes</label><select name="prefix" id="prefix-select" multiple x-model="filters.prefixes" x-tom-select x-ref="prefixesSelect" placeholder="Select prefixes...">{% for pfx in available_prefixes %}{% if pfx != '.gallery ' %}<option value="{{ pfx }}" {% if pfx in selected_prefixes %}selected{% endif %}>{{ pfx }}</option>{% endif %}{% endfor %}</select></div>
                    <div class="filter-group">
                        <label class="toggle-switch-container">
                            <span style="font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Favorites Only</span>
                            <div class="toggle-switch">
                                <input type="checkbox" name="favorites" id="favorites-check" value="true" x-model="filters.favorites">
                                <div class="toggle-switch-handle"></div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Workflow Metadata Section -->
                    <div class="workflow-section-header">
                        <h3>Workflow Parameters</h3>
                    </div>
                    
                    <div class="filter-group"><label for="model-select">Model</label><select name="filter_model" id="model-select" x-model="filters.model" x-tom-select x-ref="modelSelect" placeholder="Select model..."><option value="">All Models</option></select></div>
                    <div class="filter-group"><label for="sampler-select">Sampler</label><select name="filter_sampler" id="sampler-select" x-model="filters.sampler" x-tom-select x-ref="samplerSelect" placeholder="Select sampler..."><option value="">All Samplers</option></select></div>
                    <div class="filter-group"><label for="scheduler-select">Scheduler</label><select name="filter_scheduler" id="scheduler-select" x-model="filters.scheduler" x-tom-select x-ref="schedulerSelect" placeholder="Select scheduler..."><option value="">All Schedulers</option></select></div>
                    
                    <!-- CFG Range Pair -->
                    <div class="filter-range-pair">
                        <div class="filter-group"><label for="cfg-min-input">CFG Min</label><input type="number" name="filter_cfg_min" id="cfg-min-input" placeholder="Min CFG" step="0.1" x-model.debounce.500ms="filters.cfg_min"></div>
                        <div class="filter-group"><label for="cfg-max-input">CFG Max</label><input type="number" name="filter_cfg_max" id="cfg-max-input" placeholder="Max CFG" step="0.1" x-model.debounce.500ms="filters.cfg_max"></div>
                    </div>
                    
                    <!-- Steps Range Pair -->
                    <div class="filter-range-pair">
                        <div class="filter-group"><label for="steps-min-input">Steps Min</label><input type="number" name="filter_steps_min" id="steps-min-input" placeholder="Min Steps" step="1" x-model.debounce.500ms="filters.steps_min"></div>
                        <div class="filter-group"><label for="steps-max-input">Steps Max</label><input type="number" name="filter_steps_max" id="steps-max-input" placeholder="Max Steps" step="1" x-model.debounce.500ms="filters.steps_max"></div>
                    </div>
                    
                    <!-- Dimension Filters -->
                    <div class="dimension-filters">
                        <div class="filter-group"><label for="width-min-input">Width Min</label><input type="number" name="filter_width_min" id="width-min-input" placeholder="Min Width" step="64" x-model.debounce.500ms="filters.width_min"></div>
                        <div class="filter-group"><label for="width-max-input">Width Max</label><input type="number" name="filter_width_max" id="width-max-input" placeholder="Max Width" step="64" x-model.debounce.500ms="filters.width_max"></div>
                        <div class="filter-group"><label for="height-min-input">Height Min</label><input type="number" name="filter_height_min" id="height-min-input" placeholder="Min Height" step="64" x-model.debounce.500ms="filters.height_min"></div>
                        <div class="filter-group"><label for="height-max-input">Height Max</label><input type="number" name="filter_height_max" id="height-max-input" placeholder="Max Height" step="64" x-model.debounce.500ms="filters.height_max"></div>
                    </div>
                    </div>
                </form>
            </div>
            <div class="filter-panel-footer">
                <button type="submit" form="filter-form">Apply Filters</button>
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key) }}">Reset</a>
            </div>
        </div>
    <div id="gallery-anchor" x-ref="galleryAnchor"></div>
        <main class="gallery-container" id="gallery-container">
            <!-- Alpine x-for Gallery Grid -->
            <template x-for="file in filesOnPage" :key="file.id">
                <div class="gallery-item" 
                     :data-file-id="file.id" 
                     :data-file-type="file.type"
                     :class="{ 'selected': selectedFiles.includes(file.id) }"
                     draggable="true"
                     @dragstart="dragStart($event, file.id)">

                    <!-- NEW: Declarative Selection Overlay on Thumbnail -->
                    <div class="selection-overlay" @click.prevent="toggleSelection($event, file.id)">
                        <div class="selection-checkbox"></div>
                    </div>

                    <!-- Thumbnail Link (now the primary click target for lightbox) -->
                    <div class="thumbnail-link" @click="openLightbox(file.id)">
                        <div class="thumbnail-wrapper">
                            <!-- Media Content (This block is unchanged) -->
                            <template x-if="file.type === 'audio'">
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:#1ed760;">🎵</div>
                            </template>
                            
                            <template x-if="['image', 'animated_image'].includes(file.type)">
                                <img class="lazy" 
                                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                                     :data-src="`/galleryout/thumbnail/${file.id}`"
                                     :alt="file.name"
                                     loading="lazy"
                                     @load="$el.classList.add('loaded')"
                                     x-intersect:enter="$el.src = $el.dataset.src">
                            </template>
                            
                            <template x-if="file.type === 'video'">
                                <video autoplay muted loop playsinline class="lazy"
                                       :data-src="`/galleryout/file/${file.id}`"
                                       poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                                       x-intersect:enter="$el.src = $el.dataset.src; $el.load();">
                                </video>
                            </template>
                            
                            <template x-if="!['audio', 'image', 'animated_image', 'video'].includes(file.type)">
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--text-muted);">📄</div>
                            </template>
                            
                            <!-- MODIFIED: Workflow Badge with dynamic title -->
                            <template x-if="file.has_workflow">
                                <a :href="`/galleryout/workflow/${file.id}`"
                                   class="workflow-badge"
                                   :data-sampler-count="file.sampler_count || 0"
                                   :title="file.sampler_names ? `Samplers: ${file.sampler_names}` : (file.sampler_count > 1 ? `This workflow uses ${file.sampler_count} sampler configurations` : 'View workflow JSON')"
                                   @click.stop>
                                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px;"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path></svg>
                                   <span x-text="file.has_workflow ? 'Workflow' : ''"></span>
                                </a>
                            </template>
                            
                            <!-- Duration Overlay (Unchanged) -->
                            <template x-if="file.duration">
                                <span class="duration-overlay" x-text="file.duration"></span>
                            </template>
                        </div>
                    </div>
                    
                    <!-- NEW: Refactored Item Info section -->
                    <div class="item-info">
                        <p class="item-filename" x-text="file.name" :title="file.name"></p>

                        <!-- Prompt Preview -->
                        <template x-if="file.prompt_preview">
                            <p class="prompt-preview" x-text="file.prompt_preview"></p>
                        </template>

                        <!-- File Metadata -->
                        <div class="item-metadata">
                            <template x-if="file.dimensions">
                                <div style="display: contents;">
                                    <span class="label">Size</span>
                                    <span class="value" x-text="file.dimensions"></span>
                                </div>
                            </template>
                            <template x-if="file.mtime">
                                <div style="display: contents;">
                                    <span class="label">Date</span>
                                    <span class="value" x-text="new Date(file.mtime * 1000).toLocaleDateString()"></span>
                                </div>
                            </template>
                            <template x-if="file.sampler_names">
                                <div style="display: contents;">
                                    <span class="label">Samplers</span>
                                    <span class="value" x-text="file.sampler_names.substring(0, 25) + (file.sampler_names.length > 25 ? '...' : '')" :title="file.sampler_names"></span>
                                </div>
                            </template>
                        </div>
                        
                        <!-- NEW: Action Bar with Kebab Menu -->
                        <div class="item-actions-container">
                            <button class="item-action-btn" :class="{ 'favorited': file.is_favorite }" @click.stop="toggleFavorite(file.id)" title="Favorite" aria-label="Favorite">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            </button>
                            <template x-if="file.has_workflow">
                                <button class="item-action-btn" @click.stop="showNodeSummary(file.id)" title="Node Summary" aria-label="Node Summary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                                </button>
                            </template>
                            <a :href="`/galleryout/download/${file.id}`" class="item-action-btn" title="Download" aria-label="Download">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </a>
                            <button class="item-action-btn" @click.stop="deleteFile(file.id)" title="Delete" aria-label="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            <!-- Empty State -->
            <template x-if="filesOnPage.length === 0">
                                    <div class="empty-state" style="grid-column: 1/-1;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-muted); margin-bottom: 1rem;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                        <h3>No Files Found</h3>
                                        <p>There are no files matching your criteria in this folder.</p>
                                    </div>            </template>
        </main>
        <div id="load-more-container" x-show="filesOnPage.length < totalFiles">
            <button id="load-more-btn"
                    @click="loadMore()" 
                    :disabled="isLoadingMore" class="sort-btn" style="padding: 1rem 2.5rem;">
                <span x-show="!isLoadingMore">
                    Load More 
                    <template x-if="totalFiles - filesOnPage.length <= {{ files_per_page }}">
                        <span x-text="`(${totalFiles - filesOnPage.length} remaining)`"></span>
                    </template>
                    <template x-if="totalFiles - filesOnPage.length > {{ files_per_page }}">
                        <span x-text="`(${Math.min({{ files_per_page }}, totalFiles - filesOnPage.length)} of ${totalFiles - filesOnPage.length})`"></span>
                    </template>
                </span>
                <span x-show="isLoadingMore">Loading...</span>
            </button>
        </div>
    </div>
    <button @click="scrollToTop()" id="backToTopBtn" title="Go to Top" aria-label="Go to Top" x-show="shouldShowBackToTop" style="display: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
    <div id="drag-drop-overlay"></div>
    <div id="drop-zone-panel">
        <h3>Move to Folder:</h3>
        <div class="folder-controls" style="padding: 0 1rem; margin-top: 1rem;">
            <input type="search" 
                   class="folder-search-input" 
                   id="folder-search-move" 
                   placeholder="Search folders..."
                   x-model.debounce.300ms="$store.gallery.folderSearchTerm">
            <div class="folder-sort-buttons" id="folder-sort-move">
                <button @click="$store.gallery.folderSort = { key: 'name', dir: $store.gallery.folderSort.key === 'name' && $store.gallery.folderSort.dir === 'asc' ? 'desc' : 'asc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'name' }"
                        x-text="'A-Z' + ($store.gallery.folderSort.key === 'name' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')">A-Z</button>
                <button @click="$store.gallery.folderSort = { key: 'mtime', dir: $store.gallery.folderSort.key === 'mtime' && $store.gallery.folderSort.dir === 'desc' ? 'asc' : 'desc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'mtime' }">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span x-text="($store.gallery.folderSort.key === 'mtime' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')"></span>
                </button>
            </div>
        </div>
        <div id="drop-zone-folders">
            <div class="folder-tree-container" style="padding: 1rem;">
                <ul class="folder-tree">
                    <!-- Start the recursion by looping over the root node's children -->
                    <template x-for="folderKey in $store.gallery.folders['_root_'].children" :key="folderKey">
                        <!-- Each top-level folder in move panel -->
                        <li x-data="folderNode(folderKey)" x-show="isVisible" :class="{ 'collapsed': !isOpen }">
                            <div class="folder-item">
                                <span class="folder-toggle" :class="{ 'empty': !folder.children || folder.children.length === 0 }" @click.stop="toggle()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                                
                                <span class="folder-link" 
                                      :title="folder.display_name">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; flex-shrink: 0;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                    <span x-text="folder.display_name"></span>
                                </span>
                                
                                <button class="move-here-btn" 
                                        :disabled="key === $store.gallery.currentFolderKey"
                                        @click.stop="confirmMoveToFolder(key)"
                                        title="Move here">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                                </button>
                            </div>
                            
                            <!-- Children UL for move panel -->
                            <ul x-show="isOpen" x-collapse>
                                <template x-for="childKey in filteredAndSortedChildren" :key="childKey">
                                    <li x-data="folderNode(childKey)" x-show="isVisible" :class="{ 'collapsed': !isOpen }">
                                        <div class="folder-item">
                                            <span class="folder-toggle" :class="{ 'empty': !folder.children || folder.children.length === 0 }" @click.stop="toggle()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                                            
                                            <span class="folder-link" 
                                                  :title="folder.display_name">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; flex-shrink: 0;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                                <span x-text="folder.display_name"></span>
                                            </span>
                                            
                                            <button class="move-here-btn" 
                                                    :disabled="key === $store.gallery.currentFolderKey"
                                                    @click.stop="confirmMoveToFolder(key)"
                                                    title="Move here">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                                            </button>
                                        </div>
                                        
                                        <!-- Third level for move panel -->
                                        <ul x-show="isOpen" x-collapse>
                                            <template x-for="grandchildKey in filteredAndSortedChildren" :key="grandchildKey">
                                                <li x-data="folderNode(grandchildKey)" x-show="isVisible" :class="{ 'collapsed': !isOpen }">
                                                    <div class="folder-item">
                                                        <span class="folder-toggle" :class="{ 'empty': !folder.children || folder.children.length === 0 }" @click.stop="toggle()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                                                        
                                                        <span class="folder-link" 
                                                              :title="folder.display_name">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; flex-shrink: 0;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                                            <span x-text="folder.display_name"></span>
                                                        </span>
                                                        
                                                        <button class="move-here-btn" 
                                                                :disabled="key === $store.gallery.currentFolderKey"
                                                                @click.stop="confirmMoveToFolder(key)"
                                                                title="Move here">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                                                        </button>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </li>
                                </template>
                            </ul>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
        <button @click="hideDropZone()" class="upload-footer button">Cancel</button>
    </div>
    <div id="selection-bar" x-show="selectedFiles.length > 0" :class="{ 'visible': selectedFiles.length > 0 }">
        <span id="selection-counter" x-text="`${selectedFiles.length} file${selectedFiles.length !== 1 ? 's' : ''} selected`"></span>
        <div class="actions-grid">
            <button @click="moveSelected()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg> Move</button>
            <button @click="favoriteSelected(true)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> Add Fav</button>
            <button @click="favoriteSelected(false)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="m16 22 4-4"/></svg> Remove Fav</button>
            <button @click="deleteSelected()" class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Delete</button>
            <button @click="selectAll()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> All</button>
            <button @click="selectedFiles = []"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> None</button>
        </div>
    </div>
    <div id="lightbox-overlay" x-show="isLightboxOpen" @click.self="closeLightbox()" @keydown.arrow-left.window="navigateLightbox(-1)" @keydown.arrow-right.window="navigateLightbox(1)" @keydown.delete.window.prevent="deleteFromLightbox()" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div id="lightbox-header">
            <div id="lightbox-title" x-text="currentLightboxFile ? `${currentLightboxFile.name} (${Math.round(currentZoom * 100)}%)` : ''"></div>
            <div id="lightbox-toolbar">
                <button @click="zoomLightbox(-0.2)" title="Zoom Out" aria-label="Zoom Out"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                <button @click="zoomLightbox(0.2)" title="Zoom In" aria-label="Zoom In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                <a :href="currentLightboxFile ? `/galleryout/download/${currentLightboxFile.id}` : '#'" title="Download File" aria-label="Download File"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></a>
                <button @click="renameFileFromLightbox()" title="Rename File" aria-label="Rename File"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                <button x-show="currentLightboxFile && currentLightboxFile.has_workflow" @click="showNodeSummary(currentLightboxFile.id)" title="Node Summary" aria-label="Node Summary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg></button>
                <a x-show="currentLightboxFile && currentLightboxFile.has_workflow" :href="currentLightboxFile ? `/galleryout/workflow/${currentLightboxFile.id}` : '#'" class="workflow-btn" title="Download Workflow" aria-label="Download Workflow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path></svg></a>
                <button @click="deleteFromLightbox()" title="Delete File" aria-label="Delete File"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                <a :href="currentLightboxFile ? `/galleryout/file/${currentLightboxFile.id}` : '#'" target="_blank" title="Open in New Tab" aria-label="Open in New Tab"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>
                <button @click="closeLightbox()" title="Close" aria-label="Close"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
        </div>
        <!-- Sampler Details Panel -->
        <div class="lightbox-sampler-panel" 
             x-show="currentLightboxFile && currentLightboxFile.has_workflow" 
             style="display: none;"
             x-transition>
            
            <button @click="toggleSamplerPanel()" class="sampler-toggle-btn" :class="{ 'expanded': samplerPanelExpanded }">
                <span class="toggle-icon" style="transition: transform 0.3s;" :style="samplerPanelExpanded && { transform: 'rotate(180deg)' }">▼</span>
                <span class="toggle-text" x-text="samplerPanelExpanded ? 'Hide Sampler Details' : 'Show Sampler Details'"></span>
                <span class="sampler-badge" x-text="samplerCount" x-show="samplerCount > 0"></span>
            </button>

            <div class="sampler-content" :class="{ 'expanded': samplerPanelExpanded }">
                <!-- Loading State -->
                <div class="sampler-loader" x-show="samplerPanelLoading" x-cloak>Loading sampler data...</div>

                <!-- Error State -->
                <div class="sampler-error" x-show="samplerError" x-text="samplerError" x-cloak></div>

                <!-- Content State -->
                <div x-show="!samplerPanelLoading && !samplerError" x-cloak>
                    <template x-for="(sampler, index) in samplerData" :key="index">
                        <div class="sampler-item">
                            <div class="sampler-header">Sampler <span x-text="index + 1"></span></div>
                            <div class="sampler-grid">
                                <!-- Sampler Fields: Rendered conditionally -->
                                <template x-if="sampler.sampler_name">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Sampler:</span>
                                        <span class="sampler-field-value" x-text="sampler.sampler_name"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.scheduler">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Scheduler:</span>
                                        <span class="sampler-field-value" x-text="sampler.scheduler"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.steps != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Steps:</span>
                                        <span class="sampler-field-value" x-text="sampler.steps"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.cfg != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">CFG Scale:</span>
                                        <span class="sampler-field-value" x-text="sampler.cfg"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.denoise != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Denoise:</span>
                                        <span class="sampler-field-value" x-text="sampler.denoise"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.seed != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Seed:</span>
                                        <span class="sampler-field-value" x-text="sampler.seed"></span>
                                    </div>
                                </template>
                            </div>

                            <!-- Prompts: Rendered conditionally -->
                            <template x-if="sampler.positive_prompt">
                                <div class="sampler-prompts">
                                    <div class="sampler-prompt-label">Positive Prompt:</div>
                                    <div class="sampler-prompt-text" x-text="sampler.positive_prompt"></div>
                                </div>
                            </template>
                            <template x-if="sampler.negative_prompt">
                                <div class="sampler-prompts">
                                    <div class="sampler-prompt-label">Negative Prompt:</div>
                                    <div class="sampler-prompt-text" x-text="sampler.negative_prompt"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <div id="lightbox-content">
            <div id="lightbox-media" @wheel.prevent="zoomLightbox($event.deltaY < 0 ? 0.1 : -0.1)">
                <!-- Declarative media rendering based on file type -->
                <template x-if="currentLightboxFile?.type === 'audio'">
                    <audio :src="`/galleryout/file/${currentLightboxFile.id}`"
                           controls autoplay
                           :style="`transform: scale(${currentZoom})`"></audio>
                </template>
                
                <template x-if="currentLightboxFile && ['image', 'animated_image'].includes(currentLightboxFile.type)">
                    <img :src="`/galleryout/file/${currentLightboxFile.id}`"
                         :alt="currentLightboxFile?.name || ''"
                         :style="`transform: scale(${currentZoom})`"></img>
                </template>
                
                <template x-if="currentLightboxFile?.type === 'video'">
                    <video :src="`/galleryout/file/${currentLightboxFile.id}`"
                           controls autoplay loop
                           :style="`transform: scale(${currentZoom})`"></video>
                </template>
                
                <template x-if="currentLightboxFile && !['audio', 'image', 'animated_image', 'video'].includes(currentLightboxFile.type)">
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:var(--text-muted);">📄</div>
                </template>
            </div>
        </div>
        <button @click="navigateLightbox(-1)" class="lightbox-nav" style="left: 30px;">‹</button>
        <button @click="navigateLightbox(1)" class="lightbox-nav" style="right: 30px;">›</button>
    </div>
    <div id="node-summary-overlay" x-show="isSummaryOpen" @click.self="isSummaryOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="node-summary-panel" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="node-summary-header">
                <h2>📝 Node Summary</h2>
                <button class="close-btn" @click="isSummaryOpen = false">×</button>
            </div>
            <div id="node-summary-content">
                <!-- Loading state -->
                <template x-if="isSummaryLoading">
                    <div class="loader" style="margin:2rem auto;"></div>
                </template>

                <!-- Rendered summary data -->
                <template x-if="!isSummaryLoading">
                    <template x-for="node in summaryData" :key="node.id">
                        <div class="summary-node-item">
                            <div class="summary-node-header" :style="`background: ${node.color || 'transparent'}`">
                                <strong x-text="node.type"></strong>
                                <small x-text="` (ID: ${node.id})`"></small>
                            </div>
                            <ul class="summary-node-params">
                                <template x-if="!node.params || node.params.length === 0">
                                    <li>No parameters</li>
                                </template>
                                <template x-for="param in node.params" :key="param.name">
                                    <li>
                                        <strong x-text="param.name + ':'"></strong>
                                        <code x-text="(typeof param.value === 'object') ? JSON.stringify(param.value) : param.value"></code>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </template>

                    <template x-if="summaryData.length === 0">
                        <p>No active nodes found for this workflow.</p>
                    </template>
                </template>
            </div>
        </div>
    </div>
    <div id="upload-overlay" x-show="isUploadOpen" @click.self="isUploadOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div id="upload-panel" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="upload-header">
                <h2>Upload Files</h2>
                <p id="upload-destination-text">Upload to: <strong x-text="$store.gallery.folders[$store.gallery.currentFolderKey].display_name"></strong></p>
            </div>
            <div class="upload-body">
                <input type="file" id="upload-file-input" multiple>
                <div id="drop-zone"
                     @dragover.prevent="dragOver"
                     @dragleave="dragLeave"
                     @drop.prevent="dropFiles"
                     :class="{ 'dragover': isDragOver }">
                    <p x-text="isDragOver ? 'Drop files here...' : 'Drag & Drop files here'"></p>
                    <button type="button" id="file-upload-btn" @click="$refs.fileInput.click()">Or select files...</button>
                    <input type="file"
                           id="upload-file-input"
                           multiple
                           x-ref="fileInput"
                           @change="handleFiles($event.target.files)">
                </div>
                <ul id="file-list">
                    <template x-for="(file, index) in filesToUpload" :key="index">
                        <li>
                            <span x-text="file.name"></span>
                            <span class="file-size" x-text="`${(file.size / 1024).toFixed(1)} KB`"></span>
                        </li>
                    </template>
                </ul>
                <div id="upload-progress-container" x-show="uploadProgress > 0"><div id="upload-progress-bar"><div id="upload-progress-fill" :style="`width: ${uploadProgress}%`"></div></div></div>
            </div>
            <div class="upload-footer">
                <button type="button" @click="isUploadOpen = false">Cancel</button>
                <button type="button" id="upload-submit-btn"
                        :disabled="isUploading"
                        :class="{ 'opacity-50': isUploading }"
                        @click="performUpload()"
                        x-text="isUploading ? 'Uploading...' : 'Upload'">Upload</button>
            </div>
        </div>
    </div>
    <div id="sync-overlay" x-show="isSyncing">
        <div id="sync-panel">
            <h3 x-text="syncMessage || 'Scanning...'"></h3>
            <div id="sync-progress-bar">
                <div id="sync-progress-fill" :style="`width: ${syncProgress}%`"></div>
            </div>
        </div>
    </div>
    <div id="loader-overlay" x-show="isPageLoading" x-transition.opacity.duration.400ms>
        <div class="loader"></div>
    </div>
    
    <!-- Help Modal -->
    <div id="help-overlay" x-show="isHelpOpen" @click.self="isHelpOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2400;" x-cloak>
        <div style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow-lg); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; pointer-events: all;" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" @click.stop>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Keyboard Shortcuts</h2>
                <button @click="isHelpOpen = false" style="background: none; border: none; color: var(--text-muted); font-size: 2rem; cursor: pointer; padding: 0; line-height: 1;">×</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--accent-yellow);">Gallery Navigation</h3>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem; color: var(--text-color); font-size: 0.95rem;">
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">Ctrl+A</kbd>
                        <span>Select all items</span>
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">Esc</kbd>
                        <span>Close lightbox or panels</span>
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">←/→</kbd>
                        <span>Navigate in lightbox</span>
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">?</kbd>
                        <span>Show this help</span>
                    </div>
                </div>
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--accent-yellow);">Lightbox Controls</h3>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem; color: var(--text-color); font-size: 0.95rem;">
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">+/=</kbd>
                        <span>Zoom in</span>
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">-/_</kbd>
                        <span>Zoom out</span>
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">0</kbd>
                        <span>Reset zoom</span>
                        <kbd style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85rem; border: 1px solid var(--border-color);">F</kbd>
                        <span>Toggle favorite</span>
                    </div>
                </div>
                <div>
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--accent-yellow);">Tips</h3>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-muted); font-size: 0.9rem; line-height: 1.8;">
                        <li>Drag & drop files between folders</li>
                        <li>Click thumbnails to open in lightbox</li>
                        <li>Use filters to narrow down your gallery</li>
                        <li>Star icon marks items as favorites</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================================= -->
    <!-- PURE ALPINE.JS SCRIPT - NO GLOBALS -->
    <!-- ============================================= -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
    <script>
        // =======================================================================
        //  ALPINE.JS INITIALIZATION - ALL STATE AND LOGIC IN COMPONENTS
        // =======================================================================
        document.addEventListener('alpine:init', () => {
            try {
                // --- CUSTOM X-TOM-SELECT DIRECTIVE ---
                Alpine.directive('tom-select', (el, { expression, modifiers }, { effect, evaluateLater, cleanup }) => {
                    // Validate element has x-model
                    const modelName = el.getAttribute('x-model');
                    if (!modelName) {
                        console.error('[x-tom-select] Directive requires x-model attribute', el);
                        return;
                    }
                    
                    // Default TomSelect settings
                    const defaultSettings = {
                        plugins: [],
                        placeholder: el.getAttribute('placeholder') || 'Select...',
                        allowEmptyOption: true,
                        closeAfterSelect: !el.hasAttribute('multiple')
                    };
                    
                    // Add plugins based on element attributes
                    if (el.hasAttribute('multiple')) {
                        defaultSettings.plugins.push('checkbox_options', 'clear_button', 'remove_button');
                    }
                    
                    // Parse configuration from expression (optional)
                    let additionalConfig = {};
                    if (expression) {
                        try {
                            let getConfig = evaluateLater(expression);
                            getConfig(result => {
                                additionalConfig = result || {};
                            });
                        } catch (error) {
                            console.warn('[x-tom-select] Failed to parse config expression:', error);
                        }
                    }
                    
                    // Merge settings
                    const settings = { ...defaultSettings, ...additionalConfig };
                    
                    // Initialize TomSelect
                    let tomInstance = null;
                    let getModelValue = evaluateLater(modelName);
                    
                    // Use queueMicrotask for immediate but deferred execution
                    // This ensures Alpine has finished its initial pass before we initialize
                    queueMicrotask(() => {
                        try {
                            // Create the TomSelect instance
                            tomInstance = new TomSelect(el, {
                                ...settings,
                                onChange: (value) => {
                                    // Update Alpine state when TomSelect changes
                                    try {
                                        // Format value based on whether it's a multiple select
                                        let formattedValue;
                                        if (el.hasAttribute('multiple')) {
                                            formattedValue = Array.isArray(value) ? value : (value ? [value] : []);
                                        } else {
                                            formattedValue = value || '';
                                        }
                                        
                                        // Use Alpine's magic to set value - create a scoped evaluation
                                        const setValue = new Function('$el', 'value', `
                                            const component = window.Alpine.$data($el);
                                            const path = '${modelName}'.split('.');
                                            let obj = component;
                                            for (let i = 0; i < path.length - 1; i++) {
                                                obj = obj[path[i]];
                                            }
                                            obj[path[path.length - 1]] = value;
                                        `);
                                        setValue(el, formattedValue);
                                    } catch (error) {
                                        console.error('[x-tom-select] Error updating Alpine state:', error);
                                    }
                                }
                            });
                            
                            // Watch Alpine state and update TomSelect when it changes
                            if (tomInstance) {
                                effect(() => {
                                    getModelValue(value => {
                                        if (tomInstance) {
                                            try {
                                                // Prevent feedback loop by checking if value actually changed
                                                const currentValue = tomInstance.getValue();
                                                const newValue = value || (el.hasAttribute('multiple') ? [] : '');
                                                
                                                // Deep comparison for arrays, simple comparison for strings
                                                const hasChanged = el.hasAttribute('multiple')
                                                    ? JSON.stringify(currentValue) !== JSON.stringify(newValue)
                                                    : currentValue !== newValue;
                                                
                                                if (hasChanged) {
                                                    tomInstance.setValue(newValue, true); // true = silent (no onChange trigger)
                                                }
                                            } catch (error) {
                                                console.error('[x-tom-select] Error syncing state to TomSelect:', error);
                                            }
                                        }
                                    });
                                });
                            }
                            
                            // Store instance on element for external access
                            el._tomSelect = tomInstance;
                            
                        } catch (error) {
                            console.error('[x-tom-select] Failed to initialize TomSelect:', error, el);
                        }
                    });
                    
                    // Cleanup when element is removed
                    cleanup(() => {
                        if (tomInstance) {
                            try {
                                tomInstance.destroy();
                            } catch (error) {
                                console.warn('[x-tom-select] Error destroying instance:', error);
                            }
                            delete el._tomSelect;
                            tomInstance = null;
                        }
                    });
                });
            } catch (error) {
                console.error('[Alpine] Failed to register x-tom-select directive:', error);
            }

            // --- NOTIFICATIONS STORE ---
            try {
                Alpine.store('notifications', {
                list: [],
                add(message, type = 'info') {
                    const id = Date.now() + Math.random();
                    this.list.push({ id, message, type });
                    setTimeout(() => this.remove(id), 3000);
                },
                remove(id) {
                    this.list = this.list.filter(n => n.id !== id);
                }
            });
            } catch (error) {
                console.error('[Alpine] Failed to initialize notifications store:', error);
            }

            // --- GALLERY STORE (FOR FOLDER TREE) ---
            try {
                Alpine.store('gallery', {
                folders: {{ folders | tojson }},
                currentFolderKey: '{{ current_folder_key }}',
                ancestorKeys: {{ ancestor_keys | tojson }},
                protectedFolderKeys: {{ protected_folder_keys | tojson }},
                folderSearchTerm: '',
                folderSort: { key: 'name', dir: 'asc' },
                expandedFolderKeys: new Set(),
                
                initStore() {
                    const savedSort = localStorage.getItem('gallerySortPreference');
                    if (savedSort) {
                        const parsed = JSON.parse(savedSort);
                        if (parsed.nav) this.folderSort = parsed.nav;
                    }
                    const savedExpanded = localStorage.getItem('galleryFolderState');
                    if (savedExpanded) this.expandedFolderKeys = new Set(JSON.parse(savedExpanded));
                },
                
                saveSortState() {
                    localStorage.setItem('gallerySortPreference', JSON.stringify({ nav: this.folderSort }));
                },
                
                saveExpandedState() {
                    localStorage.setItem('galleryFolderState', JSON.stringify([...this.expandedFolderKeys]));
                }
            });
            } catch (error) {
                console.error('[Alpine] Failed to initialize gallery store:', error);
            }

            // --- FOLDER NODE COMPONENT (RECURSIVE) ---
            try {
                Alpine.data('folderNode', (folderKey) => ({
                key: folderKey,
                isOpen: false,
                
                init() {
                    this.isOpen = this.$store.gallery.ancestorKeys.includes(this.key) ||
                                  this.$store.gallery.expandedFolderKeys.has(this.key);
                },
                
                get folder() {
                    return this.$store.gallery.folders[this.key];
                },
                
                get filteredAndSortedChildren() {
                    if (!this.folder.children || !this.folder.children.length) return [];
                    const searchTerm = this.$store.gallery.folderSearchTerm.toLowerCase();
                    const allFolders = this.$store.gallery.folders;
                    const filtered = this.folder.children.filter(childKey => 
                        allFolders[childKey].display_name.toLowerCase().includes(searchTerm)
                    );
                    const sort = this.$store.gallery.folderSort;
                    return filtered.sort((aKey, bKey) => {
                        const a = allFolders[aKey];
                        const b = allFolders[bKey];
                        const dir = sort.dir === 'asc' ? 1 : -1;
                        return sort.key === 'mtime' 
                            ? (a.mtime - b.mtime) * dir
                            : a.display_name.localeCompare(b.display_name, undefined, { numeric: true }) * dir;
                    });
                },
                
                get isVisible() {
                    const term = this.$store.gallery.folderSearchTerm.toLowerCase();
                    return !term || this.folder.display_name.toLowerCase().includes(term) || 
                           this.hasVisibleChildren(this.key, term);
                },
                
                hasVisibleChildren(key, term) {
                    const folder = this.$store.gallery.folders[key];
                    if (!folder.children || !folder.children.length) return false;
                    return folder.children.some(childKey => {
                        const child = this.$store.gallery.folders[childKey];
                        return child.display_name.toLowerCase().includes(term) || 
                               this.hasVisibleChildren(childKey, term);
                    });
                },
                
                toggle() {
                    this.isOpen = !this.isOpen;
                    if (this.isOpen) this.$store.gallery.expandedFolderKeys.add(this.key);
                    else this.$store.gallery.expandedFolderKeys.delete(this.key);
                    this.$store.gallery.saveExpandedState();
                }
            }));
            } catch (error) {
                console.error('[Alpine] Failed to register folderNode component:', error);
            }
        });

        // =======================================================================
        //  MAIN GALLERY COMPONENT - ALL APPLICATION LOGIC
        // =======================================================================
        function gallery() {
            return {
                // --- SERVER DATA ---
                FILES_PER_PAGE: {{ files_per_page | default(50) }},
                
                // --- FILE STATE ---
                filesOnPage: {{ files | tojson }},
                totalFiles: {{ total_files }},
                currentPage: {{ initial_page | default(1) }},
                isLoadingMore: false,
                
                // --- SELECTION STATE ---
                selectedFiles: [],
                lastSelectedItem: null,
                
                // --- UI STATE ---
                isPageLoading: true,
                isFilterPanelOpen: false,
                isLightboxOpen: false,
                isUploadOpen: false,
                isSummaryOpen: false,
                isDropPanelVisible: false,
                isHelpOpen: false,  // NEW: Help modal state
                // Declarative summary state replaces summaryHtml
                summaryData: [],
                isSummaryLoading: false,
                // Drag image label (declarative binding for drag image element)
                dragImageLabel: '',
                
                // --- LIGHTBOX STATE ---
                currentLightboxIndex: -1,
                currentLightboxFile: null,
                currentZoom: 1,
                
                // --- UPLOAD STATE ---
                filesToUpload: [],
                uploadProgress: 0,
                isUploading: false,
                isDragOver: false,
                
                // --- SYNC STATE ---
                isSyncing: false,
                syncProgress: 0,
                syncMessage: '',
                
                // --- SAMPLER PANEL STATE (NEW) ---
                samplerPanelVisible: false,
                samplerPanelExpanded: false,
                samplerPanelLoading: false,
                samplerError: '',
                samplerCount: 0,
                samplerData: [],
                
                // --- FILTER STATE ---
                filters: {
                    search: new URLSearchParams(window.location.search).get('search') || '',
                    favorites: new URLSearchParams(window.location.search).get('favorites') === 'true',
                    extensions: new URLSearchParams(window.location.search).getAll('extension') || [],
                    prefixes: new URLSearchParams(window.location.search).getAll('prefix') || [],
                    model: new URLSearchParams(window.location.search).get('filter_model') || '',
                    sampler: new URLSearchParams(window.location.search).get('filter_sampler') || '',
                    scheduler: new URLSearchParams(window.location.search).get('filter_scheduler') || '',
                    cfg_min: new URLSearchParams(window.location.search).get('filter_cfg_min') || '',
                    cfg_max: new URLSearchParams(window.location.search).get('filter_cfg_max') || '',
                    steps_min: new URLSearchParams(window.location.search).get('filter_steps_min') || '',
                    steps_max: new URLSearchParams(window.location.search).get('filter_steps_max') || '',
                    width_min: new URLSearchParams(window.location.search).get('filter_width_min') || '',
                    width_max: new URLSearchParams(window.location.search).get('filter_width_max') || '',
                    height_min: new URLSearchParams(window.location.search).get('filter_height_min') || '',
                    height_max: new URLSearchParams(window.location.search).get('filter_height_max') || ''
                },
                
                filterOptions: {
                    models: [],
                    samplers: [],
                    schedulers: []
                },
                
                
                
                // --- UI STATE ---
                shouldShowBackToTop: false,
                sidebarExpanded: false,
                
                // --- NEW STATE FOR MOBILE SIDEBAR ---
                isMobileView: false,
                isMobileNavCollapsed: false,
                
                // ===================================
                // LIFECYCLE HOOKS
                // ===================================
                init() {
                    console.log('[Alpine] Gallery component initialized - PURE MODE');
                    
                    // Initialize stores
                    Alpine.store('gallery').initStore();
                    
                    // Check initial mobile view state
                    this.checkMobileView();
                    
                    // Hide loader - replaced with Alpine-driven state
                    this.isPageLoading = false;
                    
                    // Setup sidebar persistence (load + watch)
                    try {
                        const savedState = localStorage.getItem('sidebarExpandedState');
                        if (savedState === 'true') this.sidebarExpanded = true;
                    } catch (e) {
                        console.warn('Failed to load sidebar state:', e);
                    }
                    this.$watch('sidebarExpanded', (expanded) => {
                        try { localStorage.setItem('sidebarExpandedState', expanded ? 'true' : 'false'); }
                        catch (e) { console.warn('Failed to save sidebar state:', e); }
                    });
                    
                    // Initialize after DOM ready
                    this.$nextTick(() => {
                        this.populateWorkflowFilters();
                        this.startSyncProcess(false);
                        this.handleDeepLinking();
                    });
                    
                    // Back to top button state - managed by Alpine
                    this.shouldShowBackToTop = window.scrollY > 300;
                    
                    // Scroll handling is performed declaratively via @scroll.window on the <body>
                },
                
                // ===================================
                // COMPUTED PROPERTIES
                // ===================================
                get activeFilterCount() {
                    let count = 0;
                    
                    // Text search
                    if (this.filters.search && this.filters.search.trim()) count++;
                    
                    // Extensions (multi-select)
                    if (this.filters.extensions && this.filters.extensions.length > 0) count++;
                    
                    // Prefixes (multi-select)
                    if (this.filters.prefixes && this.filters.prefixes.length > 0) count++;
                    
                    // Favorites checkbox
                    if (this.filters.favorites) count++;
                    
                    // Workflow metadata filters
                    if (this.filters.model && this.filters.model.trim()) count++;
                    if (this.filters.sampler && this.filters.sampler.trim()) count++;
                    if (this.filters.scheduler && this.filters.scheduler.trim()) count++;
                    
                    // Range filters
                    if (this.filters.cfg_min && this.filters.cfg_min.toString().trim()) count++;
                    if (this.filters.cfg_max && this.filters.cfg_max.toString().trim()) count++;
                    if (this.filters.steps_min && this.filters.steps_min.toString().trim()) count++;
                    if (this.filters.steps_max && this.filters.steps_max.toString().trim()) count++;
                    if (this.filters.width_min && this.filters.width_min.toString().trim()) count++;
                    if (this.filters.width_max && this.filters.width_max.toString().trim()) count++;
                    if (this.filters.height_min && this.filters.height_min.toString().trim()) count++;
                    if (this.filters.height_max && this.filters.height_max.toString().trim()) count++;
                    
                    return count;
                },
                
                get activeFilterPills() {
                    const pills = [];
                    
                    // Text search
                    if (this.filters.search && this.filters.search.trim()) {
                        pills.push({
                            key: 'search',
                            label: `🔍 Search: "${this.filters.search}"`,
                            action: () => { this.filters.search = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Favorites
                    if (this.filters.favorites) {
                        pills.push({
                            key: 'favorites',
                            label: '⭐ Favorites Only',
                            action: () => { this.filters.favorites = false; this.applyFilters(); }
                        });
                    }
                    
                    // Extensions
                    if (this.filters.extensions && this.filters.extensions.length > 0) {
                        this.filters.extensions.forEach((ext, idx) => {
                            pills.push({
                                key: `ext-${idx}`,
                                label: `📄 ${ext}`,
                                action: () => {
                                    this.filters.extensions = this.filters.extensions.filter(e => e !== ext);
                                    const extSelect = this.$refs.extensionsSelect;
                                    if (extSelect && extSelect._tomSelect) {
                                        extSelect._tomSelect.removeItem(ext, true);
                                    }
                                    this.applyFilters();
                                }
                            });
                        });
                    }
                    
                    // Prefixes
                    if (this.filters.prefixes && this.filters.prefixes.length > 0) {
                        this.filters.prefixes.forEach((pfx, idx) => {
                            pills.push({
                                key: `pfx-${idx}`,
                                label: `🏷️ ${pfx}`,
                                action: () => {
                                    this.filters.prefixes = this.filters.prefixes.filter(p => p !== pfx);
                                    const pfxSelect = this.$refs.prefixesSelect;
                                    if (pfxSelect && pfxSelect._tomSelect) {
                                        pfxSelect._tomSelect.removeItem(pfx, true);
                                    }
                                    this.applyFilters();
                                }
                            });
                        });
                    }
                    
                    // Model
                    if (this.filters.model && this.filters.model.trim()) {
                        pills.push({
                            key: 'model',
                            label: `🤖 Model: ${this.filters.model}`,
                            action: () => { 
                                this.filters.model = ''; 
                                const modelSelect = this.$refs.modelSelect;
                                if (modelSelect && modelSelect._tomSelect) {
                                    modelSelect._tomSelect.clear(true);
                                }
                                this.applyFilters(); 
                            }
                        });
                    }
                    
                    // Sampler
                    if (this.filters.sampler && this.filters.sampler.trim()) {
                        pills.push({
                            key: 'sampler',
                            label: `🎲 Sampler: ${this.filters.sampler}`,
                            action: () => { 
                                this.filters.sampler = ''; 
                                const samplerSelect = this.$refs.samplerSelect;
                                if (samplerSelect && samplerSelect._tomSelect) {
                                    samplerSelect._tomSelect.clear(true);
                                }
                                this.applyFilters(); 
                            }
                        });
                    }
                    
                    // Scheduler
                    if (this.filters.scheduler && this.filters.scheduler.trim()) {
                        pills.push({
                            key: 'scheduler',
                            label: `📅 Scheduler: ${this.filters.scheduler}`,
                            action: () => { 
                                this.filters.scheduler = ''; 
                                const schedulerSelect = this.$refs.schedulerSelect;
                                if (schedulerSelect && schedulerSelect._tomSelect) {
                                    schedulerSelect._tomSelect.clear(true);
                                }
                                this.applyFilters(); 
                            }
                        });
                    }
                    
                    // CFG Range
                    if (this.filters.cfg_min && this.filters.cfg_min.toString().trim()) {
                        pills.push({
                            key: 'cfg_min',
                            label: `⚙️ CFG ≥ ${this.filters.cfg_min}`,
                            action: () => { this.filters.cfg_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.cfg_max && this.filters.cfg_max.toString().trim()) {
                        pills.push({
                            key: 'cfg_max',
                            label: `⚙️ CFG ≤ ${this.filters.cfg_max}`,
                            action: () => { this.filters.cfg_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Steps Range
                    if (this.filters.steps_min && this.filters.steps_min.toString().trim()) {
                        pills.push({
                            key: 'steps_min',
                            label: `🔢 Steps ≥ ${this.filters.steps_min}`,
                            action: () => { this.filters.steps_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.steps_max && this.filters.steps_max.toString().trim()) {
                        pills.push({
                            key: 'steps_max',
                            label: `🔢 Steps ≤ ${this.filters.steps_max}`,
                            action: () => { this.filters.steps_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Width Range
                    if (this.filters.width_min && this.filters.width_min.toString().trim()) {
                        pills.push({
                            key: 'width_min',
                            label: `📏 Width ≥ ${this.filters.width_min}`,
                            action: () => { this.filters.width_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.width_max && this.filters.width_max.toString().trim()) {
                        pills.push({
                            key: 'width_max',
                            label: `📏 Width ≤ ${this.filters.width_max}`,
                            action: () => { this.filters.width_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Height Range
                    if (this.filters.height_min && this.filters.height_min.toString().trim()) {
                        pills.push({
                            key: 'height_min',
                            label: `📐 Height ≥ ${this.filters.height_min}`,
                            action: () => { this.filters.height_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.height_max && this.filters.height_max.toString().trim()) {
                        pills.push({
                            key: 'height_max',
                            label: `📐 Height ≤ ${this.filters.height_max}`,
                            action: () => { this.filters.height_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    return pills;
                },
                
                // ===================================
                // KEYBOARD HANDLERS
                // ===================================
                // KEYBOARD HANDLERS
                // ===================================
                
                /**
                 * Checks if help modal should be shown when ? key is pressed
                 * Ensures help doesn't open when other modals are active
                 * @returns {boolean}
                 */
                shouldShowHelp() {
                    return !this.isLightboxOpen && 
                           !this.isUploadOpen && 
                           !this.isSummaryOpen && 
                           !this.isFilterPanelOpen;
                },
                
                handleEscape() {
                    if (this.isHelpOpen) this.isHelpOpen = false;
                    else if (this.isUploadOpen) this.isUploadOpen = false;
                    else if (this.isSummaryOpen) this.isSummaryOpen = false;
                    else if (this.isLightboxOpen) this.closeLightbox();
                    else if (this.isFilterPanelOpen) this.isFilterPanelOpen = false;
                    else if (this.isDropPanelVisible) this.hideDropZone();
                    else if (this.selectedFiles.length > 0) this.selectedFiles = [];
                },
                
                selectAll() {
                    this.selectedFiles = this.filesOnPage.map(f => f.id);
                    this.lastSelectedItem = this.filesOnPage.length > 0 ? 
                        this.filesOnPage[this.filesOnPage.length - 1].id : null;
                },
                
                // ===================================
                // MOBILE VIEW HANDLERS
                // ===================================
                checkMobileView() {
                    this.isMobileView = window.innerWidth <= 1024;
                    if (this.isMobileView && this.isMobileNavCollapsed === false) {
                        // On mobile, default to collapsed state
                        this.isMobileNavCollapsed = true;
                    }
                },
                
                handleResize() {
                    this.checkMobileView();
                },
                
                // ===================================
                // FILE OPERATIONS
                // ===================================
                
                /**
                 * Loads the next page of files using SQL pagination
                 * Appends new files to existing gallery without replacing them
                 * Uses Alpine filter state to build query parameters
                 * @async
                 * @returns {Promise<void>}
                 */
                async loadMore() {
                    if (this.isLoadingMore) return;
                    this.isLoadingMore = true;
                    
                    try {
                        this.currentPage++;
                        // Build query parameters from Alpine state instead of DOM
                        const queryParams = new URLSearchParams();
                        queryParams.set('page', this.currentPage);
                        
                        // Add filter values from Alpine state
                        if (this.filters.search) queryParams.set('search', this.filters.search);
                        if (this.filters.favorites) queryParams.set('favorites', 'true');
                        if (this.filters.model) queryParams.set('filter_model', this.filters.model);
                        if (this.filters.sampler) queryParams.set('filter_sampler', this.filters.sampler);
                        if (this.filters.scheduler) queryParams.set('filter_scheduler', this.filters.scheduler);
                        if (this.filters.cfg_min) queryParams.set('filter_cfg_min', this.filters.cfg_min);
                        if (this.filters.cfg_max) queryParams.set('filter_cfg_max', this.filters.cfg_max);
                        if (this.filters.steps_min) queryParams.set('filter_steps_min', this.filters.steps_min);
                        if (this.filters.steps_max) queryParams.set('filter_steps_max', this.filters.steps_max);
                        if (this.filters.width_min) queryParams.set('filter_width_min', this.filters.width_min);
                        if (this.filters.width_max) queryParams.set('filter_width_max', this.filters.width_max);
                        if (this.filters.height_min) queryParams.set('filter_height_min', this.filters.height_min);
                        if (this.filters.height_max) queryParams.set('filter_height_max', this.filters.height_max);
                        
                        // Handle arrays
                        this.filters.extensions?.forEach(ext => queryParams.append('extension', ext));
                        this.filters.prefixes?.forEach(pfx => queryParams.append('prefix', pfx));
                        
                        const response = await fetch(`/galleryout/load_more?folder_key=${this.$store.gallery.currentFolderKey}&${queryParams}`);
                        const data = await response.json();
                        
                        if (data.files && data.files.length > 0) {
                            this.filesOnPage = [...this.filesOnPage, ...data.files];
                            // Update total count in case it changed (e.g., files deleted)
                            if (data.total !== undefined) {
                                this.totalFiles = data.total;
                            }
                        } else {
                            this.$store.notifications.add('No more files to load.', 'info');
                        }
                    } catch (error) {
                        console.error('Load more error:', error);
                        this.$store.notifications.add('Failed to load more files.', 'error');
                    } finally {
                        this.isLoadingMore = false;
                    }
                },
                
                /**
                 * Toggles favorite status for a file with optimistic UI update
                 * Immediately updates UI, then syncs with server
                 * Reverts on failure to maintain consistency
                 * @async
                 * @param {string} fileId - The ID of the file to toggle
                 * @returns {Promise<void>}
                 */
                async toggleFavorite(fileId) {
                    const file = this.filesOnPage.find(f => f.id === fileId);
                    if (!file) return;
                    
                    const originalState = file.is_favorite;
                    file.is_favorite = !file.is_favorite; // Optimistic update
                    
                    try {
                        const response = await fetch(`/galleryout/toggle_favorite/${fileId}`, { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.$store.notifications.add(
                                data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!', 
                                'success'
                            );
                        } else {
                            file.is_favorite = originalState;
                            this.$store.notifications.add('Failed to update favorite.', 'error');
                        }
                    } catch (error) {
                        file.is_favorite = originalState;
                        this.$store.notifications.add('Network error updating favorite.', 'error');
                    }
                },
                
                /**
                 * Deletes a file with user confirmation
                 * Removes file from local state and updates selection
                 * @async
                 * @param {string} fileId - The ID of the file to delete
                 * @returns {Promise<void>}
                 */
                async deleteFile(fileId) {
                    if (!confirm('🗑️ Delete this file? This cannot be undone.')) return;
                    
                    try {
                        const response = await fetch(`/galleryout/delete/${fileId}`, { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.filesOnPage = this.filesOnPage.filter(f => f.id !== fileId);
                            this.selectedFiles = this.selectedFiles.filter(id => id !== fileId);
                            this.$store.notifications.add('File deleted!', 'success');
                        } else {
                            throw new Error(data.message || 'Deletion failed');
                        }
                    } catch (error) {
                        this.$store.notifications.add(`Failed to delete: ${error.message}`, 'error');
                    }
                },
                
                // ===================================
                // FILTER OPERATIONS
                // ===================================
                
                /**
                 * Clears all active filters and Tom-Select instances
                 * Resets filter state and applies empty filters to reload gallery
                 * @returns {void}
                 */
                clearAllFilters() {
                    // Reset all filter values
                    this.filters.search = '';
                    this.filters.favorites = false;
                    this.filters.extensions = [];
                    this.filters.prefixes = [];
                    this.filters.model = '';
                    this.filters.sampler = '';
                    this.filters.scheduler = '';
                    this.filters.cfg_min = '';
                    this.filters.cfg_max = '';
                    this.filters.steps_min = '';
                    this.filters.steps_max = '';
                    this.filters.width_min = '';
                    this.filters.width_max = '';
                    this.filters.height_min = '';
                    this.filters.height_max = '';
                    
                    // Clear TomSelect instances via Alpine refs (declarative)
                    [
                        this.$refs.extensionsSelect,
                        this.$refs.prefixesSelect,
                        this.$refs.modelSelect,
                        this.$refs.samplerSelect,
                        this.$refs.schedulerSelect
                    ].forEach(el => {
                        if (el && el._tomSelect) {
                            el._tomSelect.clear(true);
                        }
                    });
                    
                    // Apply filters (will show all files)
                    this.applyFilters();
                },
                
                /**
                 * Applies the current filter state to the gallery view
                 * Builds query parameters from filter state and fetches filtered results
                 * Updates URL without page reload using History API
                 * @async
                 * @returns {Promise<void>}
                 */
                async applyFilters() {
                    try {
                        // Build query parameters from filters state
                        const params = new URLSearchParams();
                        
                        // Get current sort params
                        const currentSort = new URLSearchParams(window.location.search);
                        params.set('sort_by', currentSort.get('sort_by') || 'date');
                        params.set('sort_order', currentSort.get('sort_order') || 'desc');
                        
                        // Add filter values
                        if (this.filters.search) params.set('search', this.filters.search);
                        if (this.filters.favorites) params.set('favorites', 'true');
                        
                        // Multi-select arrays
                        if (this.filters.extensions && this.filters.extensions.length > 0) {
                            this.filters.extensions.forEach(ext => params.append('extension', ext));
                        }
                        if (this.filters.prefixes && this.filters.prefixes.length > 0) {
                            this.filters.prefixes.forEach(pfx => params.append('prefix', pfx));
                        }
                        
                        // Workflow metadata
                        if (this.filters.model) params.set('filter_model', this.filters.model);
                        if (this.filters.sampler) params.set('filter_sampler', this.filters.sampler);
                        if (this.filters.scheduler) params.set('filter_scheduler', this.filters.scheduler);
                        
                        // Range filters
                        if (this.filters.cfg_min) params.set('filter_cfg_min', this.filters.cfg_min);
                        if (this.filters.cfg_max) params.set('filter_cfg_max', this.filters.cfg_max);
                        if (this.filters.steps_min) params.set('filter_steps_min', this.filters.steps_min);
                        if (this.filters.steps_max) params.set('filter_steps_max', this.filters.steps_max);
                        if (this.filters.width_min) params.set('filter_width_min', this.filters.width_min);
                        if (this.filters.width_max) params.set('filter_width_max', this.filters.width_max);
                        if (this.filters.height_min) params.set('filter_height_min', this.filters.height_min);
                        if (this.filters.height_max) params.set('filter_height_max', this.filters.height_max);
                        
                        // Update URL without reload
                        const newUrl = `${window.location.pathname}?${params.toString()}`;
                        history.pushState({}, '', newUrl);
                        
                        // Fetch filtered data
                        const response = await fetch(`/galleryout/load_more?folder_key=${this.$store.gallery.currentFolderKey}&${params.toString()}&page=1`);
                        const data = await response.json();
                        
                        if (response.ok && data.files) {
                            // Replace file list with filtered results
                            this.filesOnPage = data.files;
                            this.totalFiles = data.total || data.files.length;
                            this.currentPage = 1;
                            
                            // Close filter panel
                            this.isFilterPanelOpen = false;
                            
                            // Scroll to gallery anchor using Alpine refs (declarative)
                            if (this.$refs.galleryAnchor) this.$refs.galleryAnchor.scrollIntoView({ behavior: 'smooth' });
                            
                            // FIXED: Use totalFiles (complete count) instead of filesOnPage.length (paginated count)
                            this.$store.notifications.add(
                                `Found ${this.totalFiles} file${this.totalFiles !== 1 ? 's' : ''}` + 
                                (this.totalFiles > this.filesOnPage.length ? ` (showing ${this.filesOnPage.length})` : ''), 
                                'success'
                            );
                        } else {
                            throw new Error('Failed to fetch filtered results');
                        }
                    } catch (error) {
                        console.error('Filter application error:', error);
                        this.$store.notifications.add('Failed to apply filters. Try refreshing the page.', 'error');
                    }
                },
                
                // ===================================
                // SELECTION OPERATIONS
                // ===================================
                toggleSelection(event, fileId) {
                    if (event.shiftKey && this.lastSelectedItem) {
                        const lastIndex = this.filesOnPage.findIndex(f => f.id === this.lastSelectedItem);
                        const currentIndex = this.filesOnPage.findIndex(f => f.id === fileId);
                        const [start, end] = [lastIndex, currentIndex].sort((a, b) => a - b);
                        
                        for (let i = start; i <= end; i++) {
                            const id = this.filesOnPage[i].id;
                            if (!this.selectedFiles.includes(id)) this.selectedFiles.push(id);
                        }
                    } else {
                        const index = this.selectedFiles.indexOf(fileId);
                        if (index > -1) this.selectedFiles.splice(index, 1);
                        else this.selectedFiles.push(fileId);
                        this.lastSelectedItem = fileId;
                    }
                },
                
                async deleteSelected() {
                    const count = this.selectedFiles.length;
                    if (count === 0) return;
                    if (!confirm(`🗑️ Delete ${count} file${count !== 1 ? 's' : ''}? This cannot be undone.`)) return;
                    
                    try {
                        const response = await fetch('/galleryout/delete_batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: this.selectedFiles })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success' || data.status === 'partial_success') {
                            this.$store.notifications.add(data.message || 'Files deleted!', 'success');
                            setTimeout(() => window.location.reload(), 1200);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to delete files.', 'error');
                    }
                },
                
                async favoriteSelected(status) {
                    if (this.selectedFiles.length === 0) return;
                    
                    try {
                        const response = await fetch('/galleryout/favorite_batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: this.selectedFiles, status })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success' || data.status === 'partial_success') {
                            this.$store.notifications.add(data.message || 'Favorites updated!', 'success');
                            setTimeout(() => window.location.reload(), 1200);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to update favorites.', 'error');
                    }
                },
                
                moveSelected() {
                    if (this.selectedFiles.length > 0) this.isDropPanelVisible = true;
                },
                
                async confirmMoveToFolder(folderKey) {
                    if (this.selectedFiles.length === 0) {
                        this.$store.notifications.add('No files selected.', 'warning');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/galleryout/move_batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: this.selectedFiles, destination_folder: folderKey })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success' || data.status === 'partial_success') {
                            this.$store.notifications.add(data.message || 'Files moved!', 'success');
                            setTimeout(() => window.location.reload(), 1200);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to move files.', 'error');
                    }
                    
                    this.hideDropZone();
                },
                
                hideDropZone() {
                    this.isDropPanelVisible = false;
                },
                
                dragStart(event, fileId) {
                    if (!this.selectedFiles.includes(fileId)) {
                        this.selectedFiles = [fileId];
                    }

                    // Use Alpine-managed hidden element for drag image (declarative)
                    try {
                        // Update declarative state for drag image text
                        this.dragImageLabel = `📦 ${this.selectedFiles.length} file${this.selectedFiles.length !== 1 ? 's' : ''}`;
                        // Wait for Alpine to update the DOM, then call setDragImage
                        this.$nextTick(() => {
                            const dragImageEl = this.$refs.dragImage;
                            if (dragImageEl) {
                                try {
                                    event.dataTransfer.setDragImage(dragImageEl, 0, 0);
                                } catch (e) {
                                    console.warn('Failed to set declarative drag image:', e);
                                }
                            }
                        });
                    } catch (e) {
                        console.warn('Failed to set declarative drag image state:', e);
                    }

                    event.dataTransfer.setData('text/plain', this.selectedFiles.join(','));
                    this.isDropPanelVisible = true;
                },
                
                // ===================================
                // FOLDER OPERATIONS
                // ===================================
                async handleApiResponse(response, successMessage) {
                    const data = await response.json();
                    if (data.status === 'success' || data.status === 'partial_success') {
                        this.$store.notifications.add(data.message || successMessage, 'success');
                        setTimeout(() => window.location.reload(), 1200);
                    } else {
                        throw new Error(data.message || 'An unknown error occurred.');
                    }
                },
                
                async createFolder() {
                    const folderName = prompt('📁 Enter a name for the new folder:');
                    if (!folderName || !folderName.trim()) return;
                    try {
                        const response = await fetch('/galleryout/create_folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ folder_name: folderName.trim(), parent_key: this.$store.gallery.currentFolderKey })
                        });
                        await this.handleApiResponse(response, 'Folder created.');
                    } catch (error) {
                        this.$store.notifications.add(`Error: ${error.message}`, 'error');
                    }
                },
                
                async renameFolder(folderKey, oldName) {
                    const newName = prompt('✏️ Enter the new name for the folder:', oldName);
                    if (!newName || !newName.trim() || newName.trim() === oldName) return;
                    try {
                        const response = await fetch(`/galleryout/rename_folder/${folderKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_name: newName.trim() })
                        });
                        await this.handleApiResponse(response, 'Folder renamed.');
                    } catch (error) {
                        this.$store.notifications.add(`Error: ${error.message}`, 'error');
                    }
                },
                
                async deleteFolder(folderKey, folderName) {
                    if (!confirm(`🗑️ Delete the folder "${folderName}" and all its contents? This cannot be undone.`)) return;
                    try {
                        const response = await fetch(`/galleryout/delete_folder/${folderKey}`, { method: 'POST' });
                        await this.handleApiResponse(response, 'Folder deleted.');
                    } catch (error) {
                        this.$store.notifications.add(`Error: ${error.message}`, 'error');
                    }
                },
                
                // ===================================
                // LIGHTBOX OPERATIONS
                // ===================================
                openLightbox(fileId) {
                    this.currentLightboxIndex = this.filesOnPage.findIndex(f => f.id === fileId);
                    if (this.currentLightboxIndex === -1) return;
                    
                    this.currentZoom = 1;
                    this.isLightboxOpen = true;
                    this.showItemAtIndex(this.currentLightboxIndex);
                },
                
                closeLightbox() {
                    this.isLightboxOpen = false;
                    this.currentLightboxFile = null;
                    this.currentLightboxIndex = -1;
                    this.currentZoom = 1;
                },
                
                showItemAtIndex(index) {
                    const file = this.filesOnPage[index];
                    if (!file) return;
                    
                    this.currentLightboxFile = file;
                    this.updateLightboxTitle();
                    
                    // Load sampler data if file has workflow
                    if (file.has_workflow) {
                        this.loadAndDisplaySamplers(file.id);
                    }
                },
                
                navigateLightbox(direction) {
                    if (this.filesOnPage.length === 0) return;
                    this.currentLightboxIndex = (this.currentLightboxIndex + direction + this.filesOnPage.length) % this.filesOnPage.length;
                    this.showItemAtIndex(this.currentLightboxIndex);
                },
                
                zoomLightbox(amount) {
                    this.currentZoom = Math.max(0.5, Math.min(3, this.currentZoom + amount));
                    // Alpine will handle the zoom styling via :style binding
                },
                
                updateLightboxTitle() {
                    // Alpine automatically updates the DOM via x-text binding when currentZoom or currentLightboxFile changes
                    // No need for manual DOM manipulation
                },
                
                async loadAndDisplaySamplers(fileId) {
                    this.samplerPanelLoading = true;
                    this.samplerError = '';
                    
                    try {
                        const response = await fetch(`/galleryout/workflow_samplers/${fileId}`);
                        const data = await response.json();
                        
                        if (data.samplers && data.samplers.length > 0) {
                            this.samplerPanelLoading = false;
                            this.samplerPanelVisible = true;
                            this.samplerCount = data.samplers.length;
                            this.renderSamplerDetails(data.samplers);
                        } else {
                            this.samplerPanelLoading = false;
                            this.samplerPanelVisible = false;
                        }
                    } catch (error) {
                        this.samplerPanelLoading = false;
                        this.samplerError = 'Failed to load sampler data';
                        this.samplerPanelVisible = false;
                    }
                },
                
                renderSamplerDetails(samplers) {
                    // Convert sampler data to a format suitable for Alpine x-for rendering
                    // Map all available fields from the backend response
                    this.samplerData = samplers.map((sampler, idx) => ({
                        index: idx + 1,
                        sampler_name: sampler.sampler_name || null,
                        scheduler: sampler.scheduler || null,
                        steps: sampler.steps != null ? sampler.steps : null,
                        cfg: sampler.cfg != null ? sampler.cfg : null,
                        denoise: sampler.denoise != null ? sampler.denoise : null,
                        seed: sampler.seed != null ? sampler.seed : null,
                        positive_prompt: sampler.positive_prompt || null,
                        negative_prompt: sampler.negative_prompt || null
                    }));
                },
                
                toggleSamplerPanel() {
                    this.samplerPanelExpanded = !this.samplerPanelExpanded;
                },
                
                async renameFileFromLightbox() {
                    if (!this.currentLightboxFile) return;
                    
                    const oldName = this.currentLightboxFile.name;
                    const lastDot = oldName.lastIndexOf('.');
                    const baseName = lastDot > -1 ? oldName.substring(0, lastDot) : oldName;
                    const ext = lastDot > -1 ? oldName.substring(lastDot) : '';
                    
                    const newBaseName = prompt('Enter new file name:', baseName);
                    if (!newBaseName || newBaseName.trim() === baseName) return;
                    
                    const newName = newBaseName.trim() + ext;
                    
                    try {
                        const response = await fetch(`/galleryout/rename_file/${this.currentLightboxFile.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_name: newName })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.$store.notifications.add('File renamed!', 'success');
                            this.currentLightboxFile.name = data.new_name;
                            this.currentLightboxFile.id = data.new_id;
                            this.updateLightboxTitle();
                            this.showItemAtIndex(this.currentLightboxIndex);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to rename file.', 'error');
                    }
                },
                
                async deleteFromLightbox() {
                    if (!confirm('🗑️ Delete this file? This cannot be undone.')) return;
                    
                    const fileToDelete = this.filesOnPage[this.currentLightboxIndex];
                    
                    try {
                        const response = await fetch(`/galleryout/delete/${fileToDelete.id}`, { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.$store.notifications.add('File deleted!', 'success');
                            this.filesOnPage.splice(this.currentLightboxIndex, 1);
                            
                            if (this.filesOnPage.length === 0) {
                                this.closeLightbox();
                            } else {
                                if (this.currentLightboxIndex >= this.filesOnPage.length) {
                                    this.currentLightboxIndex = this.filesOnPage.length - 1;
                                }
                                this.showItemAtIndex(this.currentLightboxIndex);
                            }
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to delete file.', 'error');
                    }
                },
                
                // ===================================
                // MODAL OPERATIONS
                // ===================================
                async showNodeSummary(fileId) {
                    this.isSummaryOpen = true;
                    this.isSummaryLoading = true;
                    this.summaryData = [];

                    try {
                        const response = await fetch(`/galleryout/node_summary/${fileId}`);
                        const data = await response.json();

                        if (data.status === 'success' && Array.isArray(data.summary) && data.summary.length > 0) {
                            this.summaryData = data.summary.map(node => ({
                                id: node.id,
                                type: node.type,
                                color: node.color || null,
                                params: Array.isArray(node.params) ? node.params : []
                            }));
                        } else {
                            this.summaryData = [];
                        }
                    } catch (error) {
                        console.error('[showNodeSummary] Failed to load node summary:', error);
                        this.summaryData = [];
                    } finally {
                        this.isSummaryLoading = false;
                    }
                },
                
                // ===================================
                // INITIALIZATION METHODS
                // ===================================
                
                
                async populateWorkflowFilters() {
                    try {
                        const response = await fetch('/galleryout/filter_options');
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.options) {
                            // Populate Alpine state. This remains useful for other logic.
                            this.filterOptions.models = data.options.models || [];
                            this.filterOptions.samplers = data.options.samplers || [];
                            this.filterOptions.schedulers = data.options.schedulers || [];

                            // Wait for Alpine's next DOM update cycle to ensure TomSelect instances are ready.
                            await this.$nextTick();

                            // Helper to refresh a TomSelect instance programmatically using Alpine refs.
                            const refreshTomSelect = (selectRef, options, emptyText, currentValue) => {
                                if (!selectRef) {
                                    console.warn('[refreshTomSelect] selectRef is undefined');
                                    return;
                                }
                                const selectInstance = selectRef._tomSelect;
                                if (!selectInstance) {
                                    console.warn('[refreshTomSelect] TomSelect instance not found for ref', selectRef);
                                    return;
                                }

                                selectInstance.clearOptions();
                                selectInstance.addOption({ value: '', text: emptyText });

                                const formattedOptions = options.map(opt => ({
                                    value: opt.value,
                                    text: `${opt.value} (${opt.count})`
                                }));
                                selectInstance.addOptions(formattedOptions);

                                // Restore the currently selected value without triggering an onChange event.
                                selectInstance.setValue(currentValue, true);

                                // Redraw the dropdown with the new options.
                                selectInstance.refreshOptions(false);
                            };

                            // Refresh each dropdown with its fetched data and current filter value using $refs.
                            refreshTomSelect(this.$refs.modelSelect, this.filterOptions.models, 'All Models', this.filters.model);
                            refreshTomSelect(this.$refs.samplerSelect, this.filterOptions.samplers, 'All Samplers', this.filters.sampler);
                            refreshTomSelect(this.$refs.schedulerSelect, this.filterOptions.schedulers, 'All Schedulers', this.filters.scheduler);

                        } else {
                            console.warn('[populateWorkflowFilters] Unexpected response format:', data);
                            this.$store.notifications.add('Failed to load filter options', 'warning');
                        }
                    } catch (error) {
                        console.error('[populateWorkflowFilters] Failed to load workflow filter options:', error);
                        this.$store.notifications.add('Error loading filter options', 'error');
                    }
                },
                
                // --- DRAG & DROP METHODS (Declarative Alpine) ---
                dragOver() {
                    this.isDragOver = true;
                },
                
                dragLeave() {
                    this.isDragOver = false;
                },
                
                dropFiles(event) {
                    this.isDragOver = false;
                    this.handleFiles(event.dataTransfer.files);
                },
                
                handleFiles(files) {
                    if (!files || files.length === 0) return;
                    
                    // Simply add files to state - Alpine will handle DOM rendering
                    this.filesToUpload.push(...Array.from(files));
                },
                
                performUpload() {
                    if (!this.filesToUpload || this.filesToUpload.length === 0) {
                        this.$store.notifications.add('Please select files to upload.', 'warning');
                        return;
                    }
                    
                    // Set uploading state - Alpine handles UI updates
                    this.isUploading = true;
                    this.uploadProgress = 0;
                    
                    const formData = new FormData();
                    formData.append('folder_key', this.$store.gallery.currentFolderKey);
                    this.filesToUpload.forEach(file => formData.append('files', file));
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/galleryout/upload', true);
                    
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            this.uploadProgress = Math.round((event.loaded / event.total) * 100);
                        }
                    };
                    
                    xhr.onload = () => {
                        this.isUploading = false; // Reset state on completion
                        
                        if (xhr.status >= 200 && xhr.status < 300) {
                            const response = JSON.parse(xhr.responseText);
                            this.$store.notifications.add(response.message || 'Upload successful!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            this.$store.notifications.add('Upload failed.', 'error');
                        }
                    };
                    
                    xhr.onerror = () => {
                        this.isUploading = false; // Reset state on error
                        this.$store.notifications.add('An error occurred during upload.', 'error');
                    };
                    
                    xhr.send(formData);
                },
                
                startSyncProcess(isManualRefresh = false) {
                    const eventSource = new EventSource(`/galleryout/sync_status/${this.$store.gallery.currentFolderKey}`);
                    let hasChanges = false;
                    
                    if (isManualRefresh) {
                        // Set initial state for manual sync - Alpine handles DOM updates
                        this.isSyncing = true;
                        this.syncProgress = 0;
                        this.syncMessage = 'Checking for changes...';
                    }
                    
                    const cleanup = (shouldReload = false) => {
                        eventSource.close();
                        if (shouldReload) {
                            setTimeout(() => window.location.reload(), 1200);
                        } else {
                            setTimeout(() => {
                                this.isSyncing = false;
                                this.syncProgress = 0;
                                this.syncMessage = '';
                            }, isManualRefresh ? 1200 : 0);
                        }
                    };
                    
                    eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (!hasChanges && data.status !== 'no_changes') {
                                this.isSyncing = true; // Show overlay on first change
                                hasChanges = true;
                            }
                            
                            if (this.isSyncing) {
                                this.syncMessage = data.message;
                                if (data.total > 0) {
                                    this.syncProgress = Math.round((data.current / data.total) * 100);
                                }
                            }
                            
                            if (data.status === 'no_changes') {
                                if (isManualRefresh) {
                                    this.syncProgress = 100;
                                    this.$store.notifications.add('Folder is up to date.', 'info');
                                }
                                cleanup(false);
                            } else if (data.status === 'reloading') {
                                cleanup(true);
                            } else if (data.error) {
                                cleanup(false);
                            }
                        } catch (e) {
                            cleanup(false);
                        }
                    };
                    
                    eventSource.onerror = () => {
                        eventSource.close();
                        this.isSyncing = false;
                    };
                },
                
                handleDeepLinking() {
                    setTimeout(() => {
                        const hash = window.location.hash;
                        if (hash && hash.startsWith('#file-')) {
                            const fileId = hash.substring(6);
                            const file = this.filesOnPage.find(f => f.id === fileId);
                            
                            if (file) {
                                this.openLightbox(null, fileId);
                            } else {
                                // File not on current page, redirect to its location
                                fetch(`/galleryout/file_location/${fileId}?${new URLSearchParams(window.location.search)}`)
                                    .then(r => r.json())
                                    .then(d => {
                                        if (d.redirect_url) window.location.href = d.redirect_url;
                                    })
                                    .catch(() => this.$store.notifications.add('File not found.', 'error'));
                            }
                        }
                    }, 200);
                },
                
                // ===================================
                // UTILITY METHODS
                // ===================================
                escapeHTML(value) {
                    if (value === null || typeof value === 'undefined') return '<em>null</em>';
                    if (typeof value === 'object') {
                        try {
                            return JSON.stringify(value, null, 2).replace(/[&<>"']/g, m => 
                                ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]
                            );
                        } catch (e) {
                            return '[Unserializable Object]';
                        }
                    }
                    return value.toString().replace(/[&<>"']/g, m => 
                        ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]
                    );
                },
                
                scrollToTop() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
        }
    </script>
</body>
</html>